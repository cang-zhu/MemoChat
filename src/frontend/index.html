<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoChat - AIæ™ºèƒ½èŠå¤©æ‘˜è¦</title>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }
        #root {
            height: 100vh;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 18px;
            color: #666;
        }
        
        /* Markdownæ¸²æŸ“æ ·å¼ */
        .rendered-content {
            line-height: 1.6;
            color: #333;
        }
        
        .rendered-content h1, .rendered-content h2, .rendered-content h3, 
        .rendered-content h4, .rendered-content h5, .rendered-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #2c3e50;
        }
        
        .rendered-content h1 { font-size: 1.8em; border-bottom: 2px solid #3498db; padding-bottom: 0.3em; }
        .rendered-content h2 { font-size: 1.5em; border-bottom: 1px solid #bdc3c7; padding-bottom: 0.2em; }
        .rendered-content h3 { font-size: 1.3em; }
        .rendered-content h4 { font-size: 1.1em; }
        
        .rendered-content p {
            margin: 1em 0;
        }
        
        .rendered-content code {
            background-color: #f8f9fa;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
        
        .rendered-content pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1em;
            overflow-x: auto;
            margin: 1em 0;
        }
        
        .rendered-content pre code {
            background: none;
            padding: 0;
        }
        
        .rendered-content blockquote {
            border-left: 4px solid #3498db;
            margin: 1em 0;
            padding-left: 1em;
            color: #666;
            font-style: italic;
        }
        
        .rendered-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        
        .rendered-content th, .rendered-content td {
            border: 1px solid #ddd;
            padding: 0.5em;
            text-align: left;
        }
        
        .rendered-content th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .rendered-content ul, .rendered-content ol {
            margin: 1em 0;
            padding-left: 2em;
        }
        
        .rendered-content li {
            margin: 0.5em 0;
        }
        
        /* MathJaxå…¬å¼æ ·å¼ */
        .MathJax {
            font-size: 1.1em !important;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">æ­£åœ¨åŠ è½½ MemoChat...</div>
    </div>
    
    <!-- æ·»åŠ Markdownå’ŒMathJaxæ”¯æŒ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
        // MathJaxé…ç½®
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script>
        const { ipcRenderer } = require('electron');
        
        // Markdownå’ŒLaTeXæ¸²æŸ“å™¨ç±»
        class ContentRenderer {
            constructor() {
                console.log('ContentRenderer: æ„é€ å‡½æ•°è¢«è°ƒç”¨');
                // å»¶è¿Ÿåˆå§‹åŒ–markedï¼Œç¡®ä¿åº“å·²åŠ è½½
                this.markedReady = false;
                this.initMarked();
            }
            
            initMarked() {
                console.log('ContentRenderer: initMarkedè¢«è°ƒç”¨');
                console.log('ContentRenderer: typeof marked =', typeof marked);
                
                // æ£€æŸ¥markedæ˜¯å¦å·²åŠ è½½
                if (typeof marked !== 'undefined') {
                    console.log('ContentRenderer: markedåº“å·²åŠ è½½ï¼Œå¼€å§‹é…ç½®');
                    this.marked = marked;
                    // é…ç½®markedé€‰é¡¹
                    this.marked.setOptions({
                        breaks: true,
                        gfm: true,
                        tables: true,
                        sanitize: false
                    });
                    this.markedReady = true;
                    console.log('ContentRenderer: markedé…ç½®å®Œæˆï¼ŒmarkedReady =', this.markedReady);
                } else {
                    console.log('ContentRenderer: markedåº“æœªåŠ è½½ï¼Œ100msåé‡è¯•');
                    // å¦‚æœè¿˜æ²¡åŠ è½½ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                    setTimeout(() => this.initMarked(), 100);
                }
            }
            
            /**
             * æ¸²æŸ“Markdown+LaTeXå†…å®¹ä¸ºHTML
             * @param {string} rawContent - åŸå§‹Markdown+LaTeXå­—ç¬¦ä¸²
             * @returns {string} æ¸²æŸ“åçš„HTMLå­—ç¬¦ä¸²
             */
            renderContent(rawContent) {
                console.log('ContentRenderer: renderContentè¢«è°ƒç”¨');
                console.log('ContentRenderer: rawContenté•¿åº¦ =', rawContent ? rawContent.length : 0);
                console.log('ContentRenderer: markedReady =', this.markedReady);
                
                if (!rawContent) {
                    console.log('ContentRenderer: å†…å®¹ä¸ºç©ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²');
                    return '';
                }
                
                // å¦‚æœmarkedè¿˜æ²¡å‡†å¤‡å¥½ï¼Œè¿”å›åŸå§‹å†…å®¹
                if (!this.markedReady) {
                    console.log('ContentRenderer: markedæœªå‡†å¤‡å¥½ï¼Œè¿”å›è½¬ä¹‰åçš„åŸå§‹å†…å®¹');
                    return this.escapeHtml(rawContent);
                }
                
                console.log('ContentRenderer: å¼€å§‹é¢„å¤„ç†LaTeXå…¬å¼');
                // é¢„å¤„ç†LaTeXå…¬å¼
                let processedContent = this.preprocessLatex(rawContent);
                console.log('ContentRenderer: LaTeXé¢„å¤„ç†å®Œæˆ');
                
                console.log('ContentRenderer: å¼€å§‹Markdownè½¬HTML');
                // Markdownè½¬HTML
                let html = this.marked.parse(processedContent);
                console.log('ContentRenderer: Markdownè½¬HTMLå®Œæˆï¼ŒHTMLé•¿åº¦ =', html.length);
                
                return html;
            }
            
            /**
             * è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
             * @param {string} text - åŸå§‹æ–‡æœ¬
             * @returns {string} è½¬ä¹‰åçš„æ–‡æœ¬
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            /**
             * é¢„å¤„ç†LaTeXå…¬å¼ï¼Œè½¬æ¢ä¸ºMathJaxå¯è¯†åˆ«çš„æ ¼å¼
             * @param {string} content - åŸå§‹å†…å®¹
             * @returns {string} å¤„ç†åçš„å†…å®¹
             */
            preprocessLatex(content) {
                // å°†\[ ... \]æ›¿æ¢ä¸º$$ ... $$ï¼ˆå—çº§å…¬å¼ï¼‰
                content = content.replace(/\\\[([\s\S]*?)\\\]/g, (match, formula) => {
                    return `$$ ${formula} $$`;
                });
                
                // å°†[ ... ]æ›¿æ¢ä¸º$$ ... $$ï¼ˆå¦‚æœä¸åœ¨é“¾æ¥ä¸­ï¼‰
                content = content.replace(/(?<!\!)\[([^\[\]]*?)\](?!\()/g, (match, formula) => {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ•°å­¦å…¬å¼ï¼ˆåŒ…å«æ•°å­¦ç¬¦å·ï¼‰
                    if (this.isMathFormula(formula)) {
                        return `$$ ${formula} $$`;
                    }
                    return match; // ä¿æŒåŸæ ·ï¼Œå¯èƒ½æ˜¯æ™®é€šçš„æ–¹æ‹¬å·
                });
                
                // å¤„ç†è¡Œå†…å…¬å¼ \( ... \)
                content = content.replace(/\\\(([\s\S]*?)\\\)/g, (match, formula) => {
                    return `$ ${formula} $`;
                });
                
                return content;
            }
            
            /**
             * åˆ¤æ–­æ˜¯å¦ä¸ºæ•°å­¦å…¬å¼
             * @param {string} text - å¾…åˆ¤æ–­çš„æ–‡æœ¬
             * @returns {boolean} æ˜¯å¦ä¸ºæ•°å­¦å…¬å¼
             */
            isMathFormula(text) {
                // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•°å­¦ç¬¦å·
                const mathSymbols = /[\\{}^_=+\-*/()âˆ‘âˆ«âˆâˆšâˆâ‰¤â‰¥â‰ Â±Ã—Ã·âˆ‚âˆ‡âˆ†Î©âˆˆâˆ‰âŠ‚âŠƒâˆªâˆ©]/;
                const mathFunctions = /\\(text|frac|sqrt|sum|int|prod|lim|sin|cos|tan|log|ln|exp|alpha|beta|gamma|delta|epsilon|theta|lambda|mu|pi|sigma|phi|psi|omega)/;
                
                return mathSymbols.test(text) || mathFunctions.test(text);
            }
            
            /**
             * æ¸²æŸ“å†…å®¹å¹¶æ›´æ–°DOMï¼ŒåŒæ—¶åˆ·æ–°MathJax
             * @param {string} rawContent - åŸå§‹å†…å®¹
             * @param {HTMLElement} targetElement - ç›®æ ‡DOMå…ƒç´ 
             */
            renderToElement(rawContent, targetElement) {
                console.log('ContentRenderer: renderToElementè¢«è°ƒç”¨');
                console.log('ContentRenderer: targetElement =', targetElement);
                
                const html = this.renderContent(rawContent);
                console.log('ContentRenderer: è·å¾—HTMLå†…å®¹ï¼Œé•¿åº¦ =', html.length);
                
                targetElement.innerHTML = html;
                targetElement.classList.add('rendered-content');
                console.log('ContentRenderer: HTMLå·²è®¾ç½®åˆ°ç›®æ ‡å…ƒç´ ');
                
                // åˆ·æ–°MathJaxæ¸²æŸ“
                if (window.MathJax && window.MathJax.typesetPromise) {
                    console.log('ContentRenderer: å¼€å§‹MathJaxæ¸²æŸ“');
                    window.MathJax.typesetPromise([targetElement]).then(() => {
                        console.log('ContentRenderer: MathJaxæ¸²æŸ“å®Œæˆ');
                    }).catch((err) => {
                        console.warn('ContentRenderer: MathJaxæ¸²æŸ“é”™è¯¯:', err);
                    });
                } else {
                    console.log('ContentRenderer: MathJaxä¸å¯ç”¨');
                }
            }
        }
        
        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆååˆ›å»ºæ¸²æŸ“å™¨å®ä¾‹
        let contentRenderer = null;
        
        // åˆå§‹åŒ–æ¸²æŸ“å™¨
        function initRenderer() {
            if (!contentRenderer) {
                contentRenderer = new ContentRenderer();
            }
        }
        
        let initializationChecked = false;
        
        // é¡µé¢å¯¼èˆªç³»ç»Ÿ
        let pageHistory = [];
        let currentPage = null;
        
        // æ·»åŠ é¡µé¢åˆ°å†å²è®°å½•
        function addToHistory(pageName, pageData = null) {
            if (currentPage && currentPage !== pageName) {
                pageHistory.push({
                    name: currentPage,
                    data: pageData
                });
            }
            currentPage = pageName;
            updateBackButton();
        }
        
        // æ›´æ–°è¿”å›æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        function updateBackButton() {
            const backButton = document.getElementById('backButton');
            if (backButton) {
                if (pageHistory.length > 0) {
                    backButton.style.display = 'inline-block';
                } else {
                    backButton.style.display = 'none';
                }
            }
        }
        
        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            if (pageHistory.length > 0) {
                const previousPage = pageHistory.pop();
                currentPage = previousPage.name;
                
                // æ ¹æ®é¡µé¢ç±»å‹è°ƒç”¨ç›¸åº”çš„æ˜¾ç¤ºå‡½æ•°
                switch (previousPage.name) {
                    case 'main':
                        showMainApp();
                        break;
                    case 'initialization':
                        showInitializationWizard();
                        break;
                    default:
                        showMainApp();
                        break;
                }
                
                updateBackButton();
            }
        }
        
        // åˆ›å»ºè¿”å›æŒ‰é’®HTML
        function createBackButton() {
            return `
                <button id="backButton" onclick="goBack()" 
                        style="position: absolute; top: 20px; left: 20px; padding: 8px 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; display: none; z-index: 1000;">
                    â† è¿”å›
                </button>
            `;
        }

        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing renderer and checking status...');
            initRenderer();
            checkInitializationStatus();
        });
        
        // ä¸»åŠ¨æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€
        async function checkInitializationStatus() {
            if (initializationChecked) return;
            initializationChecked = true;
            
            try {
                // è·å–é…ç½®ä¿¡æ¯
                const config = await ipcRenderer.invoke('get-config');
                console.log('Config loaded:', config);
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ–
                const needsInit = !config.api.key || 
                                 (!config.chatRecords.wechat.mac && !config.chatRecords.wechat.windows &&
                                  !config.chatRecords.qq.mac && !config.chatRecords.qq.windows);
                
                console.log('Needs initialization:', needsInit);
                
                if (needsInit) {
                    showInitializationWizard();
                } else {
                    showMainApp();
                }
            } catch (error) {
                console.error('Failed to check initialization status:', error);
                // å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œé»˜è®¤æ˜¾ç¤ºåˆå§‹åŒ–ç•Œé¢
                showInitializationWizard();
            }
        }
        
        // ç›‘å¬æ¥è‡ªä¸»è¿›ç¨‹çš„åˆå§‹åŒ–çŠ¶æ€ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        ipcRenderer.on('initialization-status', (event, data) => {
            console.log('Received initialization status:', data);
            if (!initializationChecked) {
                initializationChecked = true;
                if (data.needsInitialization) {
                    showInitializationWizard();
                } else {
                    showMainApp();
                }
            }
        });
        
        function showInitializationWizard() {
            console.log('Showing initialization wizard');
            addToHistory('initialization');
            
            const root = document.getElementById('root');
            root.innerHTML = `
                ${createBackButton()}
                <div style="padding: 40px; max-width: 600px; margin: 0 auto;">
                    <h1 style="text-align: center; color: #333;">æ¬¢è¿ä½¿ç”¨ MemoChat</h1>
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h2>åˆå§‹åŒ–è®¾ç½®</h2>
                        <p>è¯·å®Œæˆä»¥ä¸‹è®¾ç½®ä»¥å¼€å§‹ä½¿ç”¨ MemoChatï¼š</p>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">API å¯†é’¥ï¼š</label>
                            <input type="text" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„é€šä¹‰åƒé—®APIå¯†é’¥" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">AIæ¨¡å‹é€‰æ‹©ï¼š</label>
                            <select id="selectedModel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                                <option value="qwen-turbo-latest">é€šä¹‰åƒé—®-Turbo (å…è´¹)</option>
                                <option value="qwen-plus-latest">é€šä¹‰åƒé—®-Plus (ä»˜è´¹)</option>
                                <option value="qwen-max-latest">é€šä¹‰åƒé—®-Max (ä»˜è´¹)</option>
                            </select>
                            <small style="display: block; color: #666; margin-top: 5px;">
                                æ¨èä½¿ç”¨ Turbo æ¨¡å‹ï¼Œå…è´¹ä¸”æ€§èƒ½ä¼˜ç§€
                            </small>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">èŠå¤©è®°å½•è·¯å¾„ï¼š</label>
                            <button onclick="selectChatPath()" 
                                    style="padding: 10px 20px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                é€‰æ‹©èŠå¤©è®°å½•ç›®å½•
                            </button>
                            <div id="selectedPath" style="margin-top: 10px; color: #666;"></div>
                        </div>
                        
                        <button onclick="completeSetup()" 
                                style="width: 100%; padding: 12px; background: #34C759; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
                            å®Œæˆè®¾ç½®
                        </button>
                    </div>
                </div>
            `;
            updateBackButton();
        }
        
        function showMainApp() {
            console.log('Showing main app');
            addToHistory('main');
            
            const root = document.getElementById('root');
            root.innerHTML = `
                ${createBackButton()}
                <div style="padding: 20px; height: 100vh; display: flex; flex-direction: column; position: relative;">
                    <header style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h1 style="margin: 0; color: #333;">MemoChat - AIæ™ºèƒ½èŠå¤©æ‘˜è¦</h1>
                        <p style="margin: 10px 0 0 0; color: #666;">æ™ºèƒ½åˆ†ææ‚¨çš„èŠå¤©è®°å½•ï¼Œç”Ÿæˆä¸“ä¸šæ‘˜è¦</p>
                    </header>
                    
                    <div style="flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h2>åŠŸèƒ½åŒºåŸŸ</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>ğŸ“ æ‰‹åŠ¨ä¸Šä¼ </h3>
                                <p>æ‰‹åŠ¨é€‰æ‹©èŠå¤©è®°å½•æ–‡ä»¶åˆ†æ</p>
                                <button onclick="uploadFile()" style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    é€‰æ‹©æ–‡ä»¶
                                </button>
                            </div>
                            
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>ğŸ”„ åˆ·æ–°æ–‡ä»¶</h3>
                                <p>é‡æ–°æ‰«æé…ç½®è·¯å¾„ä¸‹çš„æ–‡ä»¶</p>
                                <button onclick="refreshChatFiles()" style="padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    åˆ·æ–°åˆ—è¡¨
                                </button>
                            </div>
                            
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>âš™ï¸ è®¾ç½®</h3>
                                <p>ä¿®æ”¹åº”ç”¨é…ç½®å’ŒAPIå¯†é’¥</p>
                                <button onclick="openSettings()" style="padding: 8px 16px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    æ‰“å¼€è®¾ç½®
                                </button>
                            </div>
                            
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>ğŸ”§ æµ‹è¯•è¿æ¥</h3>
                                <p>æµ‹è¯•ä¸åç«¯æœåŠ¡çš„è¿æ¥çŠ¶æ€</p>
                                <button onclick="testBackendConnection()" style="padding: 8px 16px; background: #6C757D; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    æµ‹è¯•åç«¯
                                </button>
                            </div>
                        </div>
                        
                        <div id="results" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 200px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0;">èŠå¤©æ–‡ä»¶åˆ—è¡¨</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button id="chatTypeAll" onclick="switchChatType('all')" style="
                                        padding: 8px 16px; 
                                        background: #007AFF; 
                                        color: white; 
                                        border: none; 
                                        border-radius: 4px; 
                                        cursor: pointer;
                                        font-size: 14px;
                                    ">
                                        ğŸ“‚ å…¨éƒ¨
                                    </button>
                                    <button id="chatTypeWechat" onclick="switchChatType('wechat')" style="
                                        padding: 8px 16px; 
                                        background: #f8f9fa; 
                                        color: #333; 
                                        border: 1px solid #ddd; 
                                        border-radius: 4px; 
                                        cursor: pointer;
                                        font-size: 14px;
                                    ">
                                        ğŸ’¬ å¾®ä¿¡
                                    </button>
                                    <button id="chatTypeQQ" onclick="switchChatType('qq')" style="
                                        padding: 8px 16px; 
                                        background: #f8f9fa; 
                                        color: #333; 
                                        border: 1px solid #ddd; 
                                        border-radius: 4px; 
                                        cursor: pointer;
                                        font-size: 14px;
                                    ">
                                        ğŸ§ QQ
                                    </button>
                                </div>
                            </div>
                            <div id="chatFilesList">
                                <p style="color: #007AFF;">æ­£åœ¨æ£€æŸ¥åç«¯è¿æ¥...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            updateBackButton();
            
            // ç­‰å¾…åç«¯å¯åŠ¨åå†åŠ è½½èŠå¤©æ–‡ä»¶åˆ—è¡¨
            waitForBackendAndLoadFiles();
        }

        // ç­‰å¾…åç«¯å¯åŠ¨å¹¶åŠ è½½æ–‡ä»¶
        async function waitForBackendAndLoadFiles() {
            const chatFilesList = document.getElementById('chatFilesList');
            let retryCount = 0;
            const maxRetries = 15; // å¢åŠ é‡è¯•æ¬¡æ•°åˆ°15æ¬¡
            const retryDelay = 2000; // å¢åŠ å»¶è¿Ÿåˆ°2ç§’
            
            while (retryCount < maxRetries) {
                try {
                    console.log(`å°è¯•è¿æ¥åç«¯ (${retryCount + 1}/${maxRetries})...`);
                    chatFilesList.innerHTML = `<p style="color: #007AFF; text-align: center; padding: 20px;">æ­£åœ¨ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨... (${retryCount + 1}/${maxRetries})</p>`;
                    
                    // å°è¯•è¿æ¥åç«¯å¥åº·æ£€æŸ¥ç«¯ç‚¹
                    const testResult = await ipcRenderer.invoke('api-call', {
                        endpoint: '/api/health',
                        method: 'GET'
                    });
                    
                    console.log('å¥åº·æ£€æŸ¥ç»“æœ:', testResult);
                    
                    // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸä¸”åŒ…å«å¥åº·çŠ¶æ€
                    if (testResult.ok && testResult.data && testResult.data.status === 'healthy') {
                        console.log('åç«¯è¿æ¥æˆåŠŸï¼Œå¼€å§‹åŠ è½½æ–‡ä»¶åˆ—è¡¨');
                        chatFilesList.innerHTML = '<p style="color: #007AFF; text-align: center; padding: 20px;">åç«¯è¿æ¥æˆåŠŸï¼Œæ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</p>';
                        await loadChatFilesList();
                        return;
                    } else {
                        console.log('å¥åº·æ£€æŸ¥å¤±è´¥:', testResult);
                    }
                } catch (error) {
                    console.log(`è¿æ¥å°è¯• ${retryCount + 1} å¤±è´¥:`, error.message);
                }
                
                retryCount++;
                if (retryCount < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, retryDelay));
                }
            }
            
            // æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥äº†
            console.error('æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡');
            chatFilesList.innerHTML = `
                <div style="text-align: center; color: #FF3B30; padding: 20px;">
                    <p>âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡</p>
                    <p style="font-size: 14px; color: #666;">å·²å°è¯• ${maxRetries} æ¬¡è¿æ¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</p>
                    <div style="margin-top: 15px;">
                        <button onclick="waitForBackendAndLoadFiles()" style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                            é‡æ–°è¿æ¥
                        </button>
                        <button onclick="testBackendConnection()" style="padding: 8px 16px; background: #6C757D; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            æµ‹è¯•è¿æ¥
                        </button>
                    </div>
                </div>
            `;
        }

        // å½“å‰é€‰æ‹©çš„èŠå¤©ç±»å‹
        let currentChatType = 'all';
        let allChatFiles = [];

        // åˆ‡æ¢èŠå¤©ç±»å‹
        function switchChatType(type) {
            currentChatType = type;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const buttons = ['chatTypeAll', 'chatTypeWechat', 'chatTypeQQ'];
            buttons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (buttonId === `chatType${type.charAt(0).toUpperCase() + type.slice(1)}` || 
                    (type === 'all' && buttonId === 'chatTypeAll')) {
                    button.style.background = '#007AFF';
                    button.style.color = 'white';
                    button.style.border = 'none';
                } else {
                    button.style.background = '#f8f9fa';
                    button.style.color = '#333';
                    button.style.border = '1px solid #ddd';
                }
            });
            
            // è¿‡æ»¤å¹¶æ˜¾ç¤ºæ–‡ä»¶
            displayFilteredChatFiles();
        }

        // åŠ è½½èŠå¤©æ–‡ä»¶åˆ—è¡¨
        async function loadChatFilesList() {
            const chatFilesList = document.getElementById('chatFilesList');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            chatFilesList.innerHTML = '<p style="color: #007AFF; text-align: center; padding: 20px;">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</p>';
            
            try {
                // è·å–é…ç½®ä¸­çš„è·¯å¾„
                const config = await ipcRenderer.invoke('get-config');
                console.log('=== è°ƒè¯•ä¿¡æ¯ ===');
                console.log('Config loaded:', JSON.stringify(config, null, 2));
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é…ç½®çš„è·¯å¾„
                const chatRecords = config.chatRecords || {};
                console.log('Chat records:', JSON.stringify(chatRecords, null, 2));
                
                const pathsToScan = [];
                
                // æ”¶é›†æ‰€æœ‰é…ç½®çš„è·¯å¾„ï¼Œå¹¶æ ‡è®°ç±»å‹
                if (chatRecords.wechat?.windows) {
                    console.log('Adding WeChat Windows path:', chatRecords.wechat.windows);
                    pathsToScan.push({ path: chatRecords.wechat.windows, type: 'wechat' });
                }
                if (chatRecords.wechat?.mac) {
                    console.log('Adding WeChat Mac path:', chatRecords.wechat.mac);
                    pathsToScan.push({ path: chatRecords.wechat.mac, type: 'wechat' });
                }
                if (chatRecords.qq?.windows) {
                    console.log('Adding QQ Windows path:', chatRecords.qq.windows);
                    pathsToScan.push({ path: chatRecords.qq.windows, type: 'qq' });
                }
                if (chatRecords.qq?.mac) {
                    console.log('Adding QQ Mac path:', chatRecords.qq.mac);
                    pathsToScan.push({ path: chatRecords.qq.mac, type: 'qq' });
                }
                
                // å¦‚æœæ²¡æœ‰é…ç½®è·¯å¾„ï¼Œä½¿ç”¨é»˜è®¤çš„test_dataè·¯å¾„
                if (pathsToScan.length === 0) {
                    console.log('No configured paths found, using default test_data path');
                    pathsToScan.push({ 
                        path: '/Users/huaisang/Documents/ç ”ç©¶ç”Ÿ/MemoChat/MemoChat_app/test_data', 
                        type: 'general' 
                    });
                }
                
                console.log('Paths to scan:', JSON.stringify(pathsToScan, null, 2));
                
                // æ‰«ææ‰€æœ‰è·¯å¾„ä¸‹çš„æ–‡ä»¶
                allChatFiles = [];
                for (const pathInfo of pathsToScan) {
                    console.log(`=== æ‰«æè·¯å¾„: ${pathInfo.path} ===`);
                    try {
                        const result = await ipcRenderer.invoke('api-call', {
                            endpoint: '/api/scan-directory',
                            method: 'POST',
                            data: { directory_path: pathInfo.path }
                        });
                        
                        console.log(`å®Œæ•´çš„APIå“åº”:`, JSON.stringify(result, null, 2));
                        
                        // ä¿®å¤æ•°æ®ç»“æ„æ£€æŸ¥ - åç«¯æ•°æ®è¢«IPCåŒ…è£…äº†ä¸€å±‚
                        const apiData = result.data; // IPCåŒ…è£…çš„å“åº”
                        if (result.ok && apiData && apiData.ok && apiData.data && apiData.data.files) {
                            console.log(`åœ¨ ${pathInfo.path} ä¸­æ‰¾åˆ° ${apiData.data.files.length} ä¸ªæ–‡ä»¶`);
                            console.log('æ–‡ä»¶åˆ—è¡¨:', apiData.data.files);
                            
                            const newFiles = apiData.data.files.map(file => ({
                                ...file,
                                sourcePath: pathInfo.path,
                                chatType: pathInfo.type,
                                // æ ¹æ®æ–‡ä»¶åæ™ºèƒ½åˆ¤æ–­èŠå¤©ç±»å‹
                                detectedType: detectChatTypeFromFileName(file.name, pathInfo.type)
                            }));
                            
                            console.log('å¤„ç†åçš„æ–‡ä»¶:', newFiles);
                            allChatFiles = allChatFiles.concat(newFiles);
                        } else {
                            console.warn(`åœ¨ ${pathInfo.path} ä¸­æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶æˆ–å‡ºç°é”™è¯¯:`, result);
                            if (apiData && apiData.error) {
                                console.error(`æ‰«æ ${pathInfo.path} æ—¶å‡ºé”™:`, apiData.error);
                            }
                        }
                    } catch (error) {
                        console.error(`æ‰«æè·¯å¾„ ${pathInfo.path} å¤±è´¥:`, error);
                    }
                }
                
                console.log('=== æœ€ç»ˆç»“æœ ===');
                console.log('æ€»å…±æ‰¾åˆ°çš„æ–‡ä»¶æ•°é‡:', allChatFiles.length);
                console.log('æ‰€æœ‰èŠå¤©æ–‡ä»¶:', JSON.stringify(allChatFiles, null, 2));
                
                // æ˜¾ç¤ºè¿‡æ»¤åçš„æ–‡ä»¶åˆ—è¡¨
                displayFilteredChatFiles();
                
            } catch (error) {
                console.error('åŠ è½½èŠå¤©æ–‡ä»¶å¤±è´¥:', error);
                chatFilesList.innerHTML = `
                    <div style="text-align: center; color: #FF3B30; padding: 20px;">
                        <p>âŒ åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥</p>
                        <p style="font-size: 14px; color: #666;">${error.message}</p>
                        <p style="font-size: 12px; color: #999;">è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</p>
                        <button onclick="loadChatFilesList()" style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                            é‡è¯•
                        </button>
                    </div>
                `;
            }
        }

        // æ ¹æ®æ–‡ä»¶åæ™ºèƒ½åˆ¤æ–­èŠå¤©ç±»å‹
        function detectChatTypeFromFileName(fileName, defaultType) {
            const lowerName = fileName.toLowerCase();
            
            // å¾®ä¿¡ç›¸å…³å…³é”®è¯
            if (lowerName.includes('å¾®ä¿¡') || lowerName.includes('wechat') || lowerName.includes('wx')) {
                return 'wechat';
            }
            
            // QQç›¸å…³å…³é”®è¯
            if (lowerName.includes('qq') || lowerName.includes('ç¾¤èŠ') || lowerName.includes('è…¾è®¯')) {
                return 'qq';
            }
            
            return defaultType;
        }

        // æ˜¾ç¤ºè¿‡æ»¤åçš„èŠå¤©æ–‡ä»¶
        function displayFilteredChatFiles() {
            const chatFilesList = document.getElementById('chatFilesList');
            
            // æ ¹æ®å½“å‰é€‰æ‹©çš„ç±»å‹è¿‡æ»¤æ–‡ä»¶
            let filteredFiles = allChatFiles;
            if (currentChatType !== 'all') {
                filteredFiles = allChatFiles.filter(file => 
                    file.detectedType === currentChatType || file.chatType === currentChatType
                );
            }
            
            if (!filteredFiles || filteredFiles.length === 0) {
                const typeNames = {
                    'all': 'å…¨éƒ¨',
                    'wechat': 'å¾®ä¿¡',
                    'qq': 'QQ'
                };
                
                chatFilesList.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px;">
                        <p>ğŸ“‚ æœªæ‰¾åˆ°${typeNames[currentChatType]}èŠå¤©æ–‡ä»¶</p>
                        <p style="font-size: 14px;">è¯·æ£€æŸ¥è®¾ç½®ä¸­çš„è·¯å¾„é…ç½®ï¼Œæˆ–ä½¿ç”¨æ‰‹åŠ¨ä¸Šä¼ åŠŸèƒ½</p>
                        <button onclick="openSettings()" style="padding: 8px 16px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                            é…ç½®è·¯å¾„
                        </button>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æºè·¯å¾„åˆ†ç»„æ–‡ä»¶
            const filesByPath = {};
            filteredFiles.forEach(file => {
                const path = file.sourcePath || 'æœªçŸ¥è·¯å¾„';
                if (!filesByPath[path]) {
                    filesByPath[path] = [];
                }
                filesByPath[path].push(file);
            });
            
            let filesHtml = '';
            
            Object.keys(filesByPath).forEach(path => {
                const pathFiles = filesByPath[path];
                
                // è·å–è·¯å¾„ç±»å‹æ ‡è¯†
                const pathType = pathFiles[0]?.chatType || 'general';
                const typeIcons = {
                    'wechat': 'ğŸ’¬',
                    'qq': 'ğŸ§',
                    'general': 'ğŸ“'
                };
                const typeNames = {
                    'wechat': 'å¾®ä¿¡',
                    'qq': 'QQ',
                    'general': 'é€šç”¨'
                };
                
                filesHtml += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 10px; font-size: 16px;">
                            ${typeIcons[pathType]} ${typeNames[pathType]} - ${path}
                            <span style="font-size: 12px; color: #666; font-weight: normal;">(${pathFiles.length} ä¸ªæ–‡ä»¶)</span>
                        </h4>
                        <div style="display: grid; gap: 10px;">
                `;
                
                pathFiles.forEach(file => {
                    const fileSize = file.size ? formatFileSize(file.size) : 'æœªçŸ¥å¤§å°';
                    const modifiedTime = file.modified ? new Date(file.modified).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
                    
                    // æ–‡ä»¶ç±»å‹æ ‡è¯†
                    const fileTypeIcon = file.detectedType === 'wechat' ? 'ğŸ’¬' : 
                                        file.detectedType === 'qq' ? 'ğŸ§' : 'ğŸ“„';
                    
                    filesHtml += `
                        <div onclick="loadChatFile('${file.path}')" style="
                            padding: 15px; 
                            border: 1px solid #e9ecef; 
                            border-radius: 6px; 
                            cursor: pointer; 
                            transition: all 0.2s;
                            background: white;
                        " onmouseover="this.style.background='#f8f9fa'; this.style.borderColor='#007AFF'" 
                           onmouseout="this.style.background='white'; this.style.borderColor='#e9ecef'">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: #333; font-size: 14px;">
                                        ${fileTypeIcon} ${file.name}
                                    </strong>
                                    <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                        ${fileSize} â€¢ ä¿®æ”¹æ—¶é—´: ${modifiedTime}
                                    </div>
                                </div>
                                <div style="color: #007AFF; font-size: 12px;">
                                    ç‚¹å‡»åˆ†æ â†’
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                filesHtml += `
                        </div>
                    </div>
                `;
            });
            
            chatFilesList.innerHTML = filesHtml;
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // åŠ è½½èŠå¤©æ–‡ä»¶
        async function loadChatFile(filePath) {
            const results = document.getElementById('results');
            results.innerHTML = `
                <h3>åˆ†æç»“æœ</h3>
                <p>æ­£åœ¨åˆ†ææ–‡ä»¶: ${filePath}</p>
                <p style="color: #007AFF;">è¯·ç¨å€™...</p>
            `;
            
            try {
                const result = await ipcRenderer.invoke('api-call', {
                    endpoint: '/api/load-chat',
                    method: 'POST',
                    data: { file_path: filePath }
                });
                
                if (!result.ok) {
                    throw new Error(`HTTP error! status: ${result.status}`);
                }
                
                if (result.data.error) {
                    throw new Error(result.data.error);
                }
                
                // æ˜¾ç¤ºåˆ†æç»“æœ
                displayChatAnalysis(result.data, filePath);
                
            } catch (error) {
                console.error('Failed to load chat file:', error);
                results.innerHTML = `
                    <h3>åˆ†æç»“æœ</h3>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF3B30;">
                        <h4 style="margin: 0 0 10px 0; color: #FF3B30;">âŒ æ–‡ä»¶åŠ è½½å¤±è´¥</h4>
                        <p>æ–‡ä»¶: ${filePath}</p>
                        <p style="color: #666;">é”™è¯¯: ${error.message}</p>
                        <button onclick="loadChatFilesList()" style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                            è¿”å›æ–‡ä»¶åˆ—è¡¨
                        </button>
                    </div>
                `;
            }
        }

        // åˆ·æ–°èŠå¤©æ–‡ä»¶åˆ—è¡¨
        async function refreshChatFiles() {
            const chatFilesList = document.getElementById('chatFilesList');
            chatFilesList.innerHTML = '<p style="color: #007AFF;">æ­£åœ¨åˆ·æ–°æ–‡ä»¶åˆ—è¡¨...</p>';
            
            // é‡ç½®å½“å‰é€‰æ‹©çš„ç±»å‹ä¸ºå…¨éƒ¨
            currentChatType = 'all';
            switchChatType('all');
            
            // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
            await loadChatFilesList();
        }

        // è®¾ç½®é¡µé¢
        function openSettings() {
            console.log('Opening settings');
            addToHistory('settings');
            
            const root = document.getElementById('root');
            root.innerHTML = `
                ${createBackButton()}
                <div style="padding: 40px; max-width: 800px; margin: 0 auto;">
                    <h1 style="text-align: center; color: #333;">âš™ï¸ åº”ç”¨è®¾ç½®</h1>
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        
                        <!-- APIè®¾ç½®åŒºåŸŸ -->
                        <div style="margin-bottom: 40px;">
                            <h3 style="color: #495057; margin-bottom: 20px; font-size: 18px;">ğŸ”‘ APIè®¾ç½®</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">é€šä¹‰åƒé—®APIå¯†é’¥:</label>
                                <input type="password" id="settingsApiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥ (sk-xxxxxxxx...)" 
                                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                                <button onclick="saveAPIKey()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-top: 10px;">
                                    ä¿å­˜APIå¯†é’¥
                                </button>
                                <small style="display: block; color: #666; margin-top: 4px;">
                                    æ‚¨å¯ä»¥åœ¨ <a href="https://dashscope.console.aliyun.com/" target="_blank" rel="noopener noreferrer">é˜¿é‡Œäº‘ç™¾ç‚¼æ§åˆ¶å°</a> è·å–APIå¯†é’¥
                                </small>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">ğŸ¤– AIæ¨¡å‹é€‰æ‹©:</label>
                                
                                <!-- å½“å‰æ¨¡å‹æ˜¾ç¤º -->
                                <div id="currentModelDisplay" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;">
                                    <strong>å½“å‰æ¨¡å‹:</strong> <span id="currentModelName">åŠ è½½ä¸­...</span>
                                    <span id="currentModelBadge" style="margin-left: 10px; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;"></span>
                                </div>
                                
                                <select id="settingsSelectedModel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                                    <option value="qwen-turbo-latest">é€šä¹‰åƒé—®-Turbo (å…è´¹)</option>
                                    <option value="qwen-plus-latest">é€šä¹‰åƒé—®-Plus (ä»˜è´¹)</option>
                                    <option value="qwen-max-latest">é€šä¹‰åƒé—®-Max (ä»˜è´¹)</option>
                                </select>
                                <button onclick="saveModel()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-top: 10px;">
                                    ä¿å­˜æ¨¡å‹é…ç½®
                                </button>
                                
                                <div id="modelInfo" style="margin-top: 10px; font-size: 14px;">
                                    <span style="color: #28a745;">âœ… å…è´¹æ¨¡å‹ï¼Œæ— éœ€é¢å¤–è´¹ç”¨</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- èŠå¤©è®°å½•è·¯å¾„è®¾ç½®åŒºåŸŸ -->
                        <div style="margin-bottom: 40px;">
                            <h3 style="color: #495057; margin-bottom: 20px; font-size: 18px;">ğŸ“ èŠå¤©è®°å½•è·¯å¾„è®¾ç½®</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">å¾®ä¿¡èŠå¤©è®°å½•è·¯å¾„ (Windows):</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="wechatWindowsPath" readonly placeholder="æœªè®¾ç½®è·¯å¾„" 
                                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button onclick="selectPath('wechat', 'windows')" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        é€‰æ‹©è·¯å¾„
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">å¾®ä¿¡èŠå¤©è®°å½•è·¯å¾„ (Mac):</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="wechatMacPath" readonly placeholder="æœªè®¾ç½®è·¯å¾„" 
                                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button onclick="selectPath('wechat', 'mac')" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        é€‰æ‹©è·¯å¾„
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">QQèŠå¤©è®°å½•è·¯å¾„ (Windows):</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="qqWindowsPath" readonly placeholder="æœªè®¾ç½®è·¯å¾„" 
                                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button onclick="selectPath('qq', 'windows')" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        é€‰æ‹©è·¯å¾„
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">QQèŠå¤©è®°å½•è·¯å¾„ (Mac):</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="qqMacPath" readonly placeholder="æœªè®¾ç½®è·¯å¾„" 
                                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button onclick="selectPath('qq', 'mac')" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        é€‰æ‹©è·¯å¾„
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ¶ˆæ¯æç¤ºåŒºåŸŸ -->
                        <div id="settingsMessage" style="display: none; padding: 10px; margin: 20px 0; border-radius: 4px; border: 1px solid;"></div>
                    </div>
                </div>
            `;
            updateBackButton();
            loadSettingsData();
        }

        // åŠ è½½è®¾ç½®æ•°æ®
        async function loadSettingsData() {
            try {
                const config = await ipcRenderer.invoke('get-config');
                console.log('Settings config loaded:', config);
                
                // åŠ è½½APIå¯†é’¥
                if (config.api?.key) {
                    document.getElementById('settingsApiKey').value = config.api.key;
                }
                
                // åŠ è½½å½“å‰æ¨¡å‹
                const currentModel = config.api?.model || 'qwen-turbo-latest';
                document.getElementById('settingsSelectedModel').value = currentModel;
                
                // æ˜¾ç¤ºå½“å‰æ¨¡å‹ä¿¡æ¯
                const modelNames = {
                    'qwen-turbo-latest': 'é€šä¹‰åƒé—®-Turbo (å…è´¹)',
                    'qwen-plus-latest': 'é€šä¹‰åƒé—®-Plus (ä»˜è´¹)',
                    'qwen-max-latest': 'é€šä¹‰åƒé—®-Max (ä»˜è´¹)'
                };
                
                const modelFree = {
                    'qwen-turbo-latest': true,
                    'qwen-plus-latest': false,
                    'qwen-max-latest': false
                };
                
                document.getElementById('currentModelName').textContent = modelNames[currentModel];
                const badge = document.getElementById('currentModelBadge');
                badge.textContent = modelFree[currentModel] ? 'å…è´¹' : 'ä»˜è´¹';
                badge.style.background = modelFree[currentModel] ? '#28a745' : '#ffc107';
                badge.style.color = modelFree[currentModel] ? 'white' : '#212529';
                
                // æ›´æ–°æ¨¡å‹ä¿¡æ¯
                updateModelInfo(currentModel);
                
                // åŠ è½½èŠå¤©è·¯å¾„
                const chatPaths = await ipcRenderer.invoke('get-chat-paths');
                if (chatPaths?.wechat?.windows) {
                    document.getElementById('wechatWindowsPath').value = chatPaths.wechat.windows;
                }
                if (chatPaths?.wechat?.mac) {
                    document.getElementById('wechatMacPath').value = chatPaths.wechat.mac;
                }
                if (chatPaths?.qq?.windows) {
                    document.getElementById('qqWindowsPath').value = chatPaths.qq.windows;
                }
                if (chatPaths?.qq?.mac) {
                    document.getElementById('qqMacPath').value = chatPaths.qq.mac;
                }
                
            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                showSettingsMessage('åŠ è½½è®¾ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°æ¨¡å‹ä¿¡æ¯æ˜¾ç¤º
        function updateModelInfo(model) {
            const modelInfo = document.getElementById('modelInfo');
            if (model === 'qwen-turbo-latest') {
                modelInfo.innerHTML = '<span style="color: #28a745;">âœ… å…è´¹æ¨¡å‹ï¼Œæ— éœ€é¢å¤–è´¹ç”¨</span>';
            } else {
                modelInfo.innerHTML = '<span style="color: #ffc107;">ğŸ’° ä»˜è´¹æ¨¡å‹ï¼Œéœ€è¦ç›¸åº”æƒé™å’Œä½™é¢</span>';
            }
        }

        // ç›‘å¬æ¨¡å‹é€‰æ‹©å˜åŒ–
        document.addEventListener('change', function(e) {
            if (e.target.id === 'settingsSelectedModel') {
                updateModelInfo(e.target.value);
            }
        });

        // æ˜¾ç¤ºè®¾ç½®æ¶ˆæ¯
        function showSettingsMessage(message, type = 'success') {
            const messageDiv = document.getElementById('settingsMessage');
            messageDiv.style.display = 'block';
            messageDiv.textContent = message;
            
            if (type === 'success') {
                messageDiv.style.background = '#d4edda';
                messageDiv.style.color = '#155724';
                messageDiv.style.borderColor = '#c3e6cb';
            } else {
                messageDiv.style.background = '#f8d7da';
                messageDiv.style.color = '#721c24';
                messageDiv.style.borderColor = '#f5c6cb';
            }
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // ä¿å­˜APIå¯†é’¥
        async function saveAPIKey() {
            const apiKey = document.getElementById('settingsApiKey').value;
            if (!apiKey) {
                showSettingsMessage('è¯·è¾“å…¥APIå¯†é’¥', 'error');
                return;
            }
            
            try {
                const result = await ipcRenderer.invoke('save-api-key', apiKey);
                if (result.success) {
                    showSettingsMessage('APIå¯†é’¥ä¿å­˜æˆåŠŸ');
                } else {
                    showSettingsMessage('ä¿å­˜å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showSettingsMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¿å­˜æ¨¡å‹é…ç½®
        async function saveModel() {
            const selectedModel = document.getElementById('settingsSelectedModel').value;
            
            try {
                const result = await ipcRenderer.invoke('save-model-config', selectedModel);
                if (result.success) {
                    showSettingsMessage('æ¨¡å‹é…ç½®ä¿å­˜æˆåŠŸ');
                    // æ›´æ–°å½“å‰æ¨¡å‹æ˜¾ç¤º
                    loadSettingsData();
                } else {
                    showSettingsMessage('ä¿å­˜å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showSettingsMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é€‰æ‹©è·¯å¾„
        async function selectPath(platform, os) {
            try {
                const path = await ipcRenderer.invoke('select-directory');
                if (path) {
                    const inputId = `${platform}${os.charAt(0).toUpperCase() + os.slice(1)}Path`;
                    document.getElementById(inputId).value = path;
                    
                    // ä¿å­˜è·¯å¾„ - ä¿®å¤å‚æ•°ç»“æ„
                    const result = await ipcRenderer.invoke('save-chat-path', { 
                        platform: os, 
                        type: platform, 
                        path: path 
                    });
                    if (result.success) {
                        showSettingsMessage(`${platform.toUpperCase()} ${os} è·¯å¾„ä¿å­˜æˆåŠŸ`);
                    } else {
                        showSettingsMessage('è·¯å¾„ä¿å­˜å¤±è´¥: ' + result.error, 'error');
                    }
                }
            } catch (error) {
                showSettingsMessage('é€‰æ‹©è·¯å¾„å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆå§‹åŒ–è®¾ç½®ç›¸å…³å‡½æ•°
        async function selectChatPath() {
            try {
                const path = await ipcRenderer.invoke('select-directory');
                if (path) {
                    document.getElementById('selectedPath').textContent = `å·²é€‰æ‹©: ${path}`;
                    window.selectedChatPath = path;
                }
            } catch (error) {
                alert('é€‰æ‹©ç›®å½•å¤±è´¥: ' + error.message);
            }
        }
        
        async function completeSetup() {
            const apiKey = document.getElementById('apiKey').value;
            const selectedModel = document.getElementById('selectedModel').value;
            const chatPath = window.selectedChatPath;
            
            if (!apiKey) {
                alert('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }
            
            if (!chatPath) {
                alert('è¯·é€‰æ‹©èŠå¤©è®°å½•è·¯å¾„');
                return;
            }
            
            try {
                const result = await ipcRenderer.invoke('complete-initialization', {
                    apiKey: apiKey,
                    selectedModel: selectedModel,
                    chatPaths: {
                        wechat: chatPath,
                        qq: chatPath
                    }
                });
                
                if (result.success) {
                    alert('è®¾ç½®å®Œæˆï¼');
                    showMainApp();
                } else {
                    alert('è®¾ç½®å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }
        
        // æµ‹è¯•åç«¯è¿æ¥å‡½æ•°
        async function testBackendConnection() {
            const results = document.getElementById('results');
            results.innerHTML = `
                <h3>åç«¯è¿æ¥æµ‹è¯•</h3>
                <p style="color: #007AFF;">æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...</p>
            `;
            
            try {
                const result = await ipcRenderer.invoke('api-call', {
                    endpoint: '/api/scan-directory',
                    method: 'POST',
                    data: { directory_path: '/Users/huaisang/Documents/ç ”ç©¶ç”Ÿ/MemoChat/MemoChat_app/test_data' }
                });
                
                console.log('Backend connection test result:', result);
                
                if (result.ok) {
                    results.innerHTML = `
                        <h3>åç«¯è¿æ¥æµ‹è¯•</h3>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #34C759;">
                            <h4 style="margin: 0 0 10px 0; color: #34C759;">âœ… åç«¯è¿æ¥æ­£å¸¸</h4>
                            <p>æ‰¾åˆ° ${result.data.files ? result.data.files.length : 0} ä¸ªæ–‡ä»¶</p>
                            <p style="font-size: 12px; color: #666;">æµ‹è¯•ç›®å½•: ${result.data.directory}</p>
                            ${result.data.files && result.data.files.length > 0 ? 
                                `<details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #007AFF;">æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨</summary>
                                    <ul style="margin: 10px 0; padding-left: 20px;">
                                        ${result.data.files.map(file => `<li>${file.name} (${file.size} bytes)</li>`).join('')}
                                    </ul>
                                </details>` : ''
                            }
                        </div>
                    `;
                } else {
                    results.innerHTML = `
                        <h3>åç«¯è¿æ¥æµ‹è¯•</h3>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF3B30;">
                            <h4 style="margin: 0 0 10px 0; color: #FF3B30;">âŒ åç«¯è¿æ¥å¤±è´¥</h4>
                            <p>çŠ¶æ€ç : ${result.status}</p>
                            <p>é”™è¯¯ä¿¡æ¯: ${result.error || result.data?.error || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Backend connection test failed:', error);
                results.innerHTML = `
                    <h3>åç«¯è¿æ¥æµ‹è¯•</h3>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF3B30;">
                        <h4 style="margin: 0 0 10px 0; color: #FF3B30;">âŒ è¿æ¥å¼‚å¸¸</h4>
                        <p>é”™è¯¯: ${error.message}</p>
                        <p style="font-size: 12px; color: #666;">å¯èƒ½åŸå› ï¼šåç«¯æœåŠ¡æœªå¯åŠ¨æˆ–ç«¯å£è¢«å ç”¨</p>
                    </div>
                `;
            }
        }
        
        // ä¸»åº”ç”¨åŠŸèƒ½å‡½æ•°
        async function uploadFile() {
            try {
                const filePath = await ipcRenderer.invoke('select-file');
                if (filePath) {
                    document.getElementById('results').innerHTML = `
                        <h3>åˆ†æç»“æœ</h3>
                        <p>å·²é€‰æ‹©æ–‡ä»¶: ${filePath}</p>
                        <p style="color: #007AFF;">æ­£åœ¨åˆ†æä¸­...</p>
                    `;
                    
                    // ä½¿ç”¨IPCè°ƒç”¨åç«¯API
                    try {
                        const result = await ipcRenderer.invoke('api-call', {
                            endpoint: '/api/load-chat',
                            method: 'POST',
                            data: { file_path: filePath }
                        });
                        
                        if (!result.ok) {
                            throw new Error(`HTTP error! status: ${result.status}`);
                        }
                        
                        if (result.data.error) {
                            throw new Error(result.data.error);
                        }
                        
                        // æ˜¾ç¤ºåˆ†æç»“æœ
                        displayChatAnalysis(result.data, filePath);
                        
                    } catch (apiError) {
                        console.error('APIè°ƒç”¨å¤±è´¥:', apiError);
                        document.getElementById('results').innerHTML = `
                            <h3>åˆ†æç»“æœ</h3>
                            <p>å·²é€‰æ‹©æ–‡ä»¶: ${filePath}</p>
                            <p style="color: #FF3B30;">åˆ†æå¤±è´¥: ${apiError.message}</p>
                            <p style="color: #666;">è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œæˆ–ç¨åé‡è¯•ã€‚</p>
                        `;
                    }
                }
            } catch (error) {
                alert('æ–‡ä»¶é€‰æ‹©å¤±è´¥: ' + error.message);
            }
        }
        
        async function scanChats() {
            // è¿™ä¸ªå‡½æ•°ç°åœ¨è¢« refreshChatFiles æ›¿ä»£
            await refreshChatFiles();
        }
        
        function displayChatAnalysis(data, filePath) {
            // å­˜å‚¨å½“å‰æ•°æ®ä¾›åç»­åŠŸèƒ½ä½¿ç”¨
            currentChatData = data.chat_data;
            currentFilePath = filePath;
            
            const results = document.getElementById('results');
            results.innerHTML = `
                <h3>åˆ†æç»“æœ</h3>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #007AFF;">ğŸ“„ æ–‡ä»¶ä¿¡æ¯</h4>
                    <p style="margin: 5px 0;"><strong>æ–‡ä»¶è·¯å¾„:</strong> ${filePath}</p>
                    <p style="margin: 5px 0;"><strong>æ¶ˆæ¯æ€»æ•°:</strong> ${data.total_messages || currentChatData?.length || 0}</p>
                    <p style="margin: 5px 0;"><strong>å‚ä¸äººæ•°:</strong> ${data.contacts?.length || 0}</p>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #FF6B35;">
                    <h4 style="margin: 0 0 15px 0; color: #FF6B35;">ğŸ¤– AIæ™ºèƒ½åˆ†æ</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="generateAISummary()" style="padding: 10px 20px; background: #FF6B35; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            ğŸ§  å…¨æ–‡AIæ‘˜è¦
                        </button>
                        <button onclick="generateKeywordAnalysis()" style="padding: 10px 20px; background: #34C759; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            ğŸ” å…³é”®è¯åˆ†æ
                        </button>
                        <button onclick="generateSentimentAnalysis()" style="padding: 10px 20px; background: #007AFF; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            ğŸ˜Š æƒ…æ„Ÿåˆ†æ
                        </button>
                    </div>
                </div>
                
                <div id="analysisResults" style="margin-bottom: 15px;">
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #007AFF;">
                    <h4 style="margin: 0 0 15px 0; color: #007AFF;">ğŸ’¬ èŠå¤©åˆ—è¡¨</h4>
                    <div id="chatList" style="max-height: 300px; overflow-y: auto;">
                        ${generateChatList(currentChatData)}
                    </div>
                </div>
                
                <div id="chatRecordArea" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #34C759;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #34C759;">ğŸ“‹ èŠå¤©è®°å½•</h4>
                        <div>
                            <button id="selectRangeBtn" onclick="toggleRangeSelection()" style="padding: 6px 12px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 10px;">
                                ğŸ” é€‰æ‹©èŒƒå›´
                            </button>
                            <button id="generateSummaryBtn" onclick="generateSelectedSummary()" style="padding: 6px 12px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" disabled>
                                ğŸ“ ç”Ÿæˆå±€éƒ¨æ‘˜è¦
                            </button>
                        </div>
                    </div>
                    <div id="chatMessages" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px;">
                    </div>
                    <div id="selectionInfo" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none;">
                        <small>å·²é€‰æ‹© <span id="selectedCount">0</span> æ¡æ¶ˆæ¯</small>
                    </div>
                </div>
                
                <div id="summaryResultArea" style="display: none;">
                </div>
            `;
        }

        // ç”ŸæˆèŠå¤©åˆ—è¡¨
        function generateChatList(chatData) {
            if (!chatData || chatData.length === 0) {
                return '<p style="color: #666; text-align: center;">æ²¡æœ‰æ‰¾åˆ°èŠå¤©è®°å½•</p>';
            }

            // æŒ‰æ—¥æœŸåˆ†ç»„èŠå¤©è®°å½•
            const chatsByDate = {};
            chatData.forEach((message, index) => {
                const date = new Date(message.timestamp).toLocaleDateString('zh-CN');
                if (!chatsByDate[date]) {
                    chatsByDate[date] = [];
                }
                chatsByDate[date].push({...message, originalIndex: index});
            });

            let listHtml = '';
            Object.keys(chatsByDate).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
                const messages = chatsByDate[date];
                const messageCount = messages.length;
                const participants = [...new Set(messages.map(m => m.sender || 'æœªçŸ¥ç”¨æˆ·'))];
                
                listHtml += `
                    <div onclick="showChatRecord('${date}')" style="
                        padding: 12px; 
                        margin-bottom: 8px; 
                        border: 1px solid #e9ecef; 
                        border-radius: 6px; 
                        cursor: pointer; 
                        transition: all 0.2s;
                        background: #f8f9fa;
                    " onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #333;">${date}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                    ${messageCount} æ¡æ¶ˆæ¯ â€¢ ${participants.length} äººå‚ä¸
                                </div>
                                <div style="font-size: 11px; color: #999; margin-top: 2px;">
                                    å‚ä¸è€…: ${participants.slice(0, 3).join(', ')}${participants.length > 3 ? '...' : ''}
                                </div>
                            </div>
                            <div style="color: #007AFF; font-size: 12px;">
                                ç‚¹å‡»æŸ¥çœ‹ â†’
                            </div>
                        </div>
                    </div>
                `;
            });

            return listHtml;
        }

        // æ˜¾ç¤ºç‰¹å®šæ—¥æœŸçš„èŠå¤©è®°å½•
        function showChatRecord(date) {
            const chatRecordArea = document.getElementById('chatRecordArea');
            const chatMessages = document.getElementById('chatMessages');
            
            // ç­›é€‰å‡ºæŒ‡å®šæ—¥æœŸçš„æ¶ˆæ¯
            const dateMessages = currentChatData.filter(message => {
                const messageDate = new Date(message.timestamp).toLocaleDateString('zh-CN');
                return messageDate === date;
            });

            // æ˜¾ç¤ºèŠå¤©è®°å½•åŒºåŸŸ
            chatRecordArea.style.display = 'block';
            
            // æ›´æ–°æ ‡é¢˜
            chatRecordArea.querySelector('h4').textContent = `ğŸ“‹ ${date} çš„èŠå¤©è®°å½• (${dateMessages.length} æ¡æ¶ˆæ¯)`;
            
            // ç”Ÿæˆæ¶ˆæ¯åˆ—è¡¨
            let messagesHtml = '';
            dateMessages.forEach((message, index) => {
                const timestamp = new Date(message.timestamp).toLocaleTimeString('zh-CN');
                const originalIndex = currentChatData.indexOf(message);
                
                messagesHtml += `
                    <div class="message-item" data-index="${originalIndex}" style="
                        margin-bottom: 10px; 
                        padding: 10px 40px 10px 10px; 
                        border-radius: 6px; 
                        border-left: 3px solid #007AFF;
                        background: #ffffff;
                        cursor: pointer;
                        transition: all 0.2s;
                        position: relative;
                    " onclick="toggleMessageSelection(this)">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding-right: 30px;">
                            <strong style="color: #333;">${message.sender || 'æœªçŸ¥ç”¨æˆ·'}</strong>
                            <span style="font-size: 12px; color: #666; white-space: nowrap;">${timestamp}</span>
                        </div>
                        <div style="line-height: 1.4; color: #555; padding-right: 30px;">
                            ${message.content || message.message || ''}
                        </div>
                        <div class="selection-indicator" style="
                            position: absolute; 
                            right: 10px; 
                            top: 10px; 
                            width: 20px; 
                            height: 20px; 
                            border: 2px solid #ddd; 
                            border-radius: 50%; 
                            display: none;
                            background: white;
                            z-index: 10;
                        "></div>
                    </div>
                `;
            });
            
            chatMessages.innerHTML = messagesHtml;
            
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            selectedMessages = [];
            updateSelectionInfo();
            
            // æ»šåŠ¨åˆ°èŠå¤©è®°å½•åŒºåŸŸ
            chatRecordArea.scrollIntoView({ behavior: 'smooth' });
        }

        // å…¨å±€å˜é‡å­˜å‚¨é€‰æ‹©çŠ¶æ€
        let isRangeSelectionMode = false;
        let selectedMessages = [];

        // åˆ‡æ¢èŒƒå›´é€‰æ‹©æ¨¡å¼
        function toggleRangeSelection() {
            isRangeSelectionMode = !isRangeSelectionMode;
            const selectRangeBtn = document.getElementById('selectRangeBtn');
            const selectionInfo = document.getElementById('selectionInfo');
            
            if (isRangeSelectionMode) {
                selectRangeBtn.textContent = 'âœ… å®Œæˆé€‰æ‹©';
                selectRangeBtn.style.background = '#28a745';
                selectionInfo.style.display = 'block';
                
                // æ˜¾ç¤ºé€‰æ‹©æŒ‡ç¤ºå™¨
                document.querySelectorAll('.message-item').forEach(item => {
                    item.style.position = 'relative';
                    const indicator = item.querySelector('.selection-indicator');
                    if (indicator) {
                        indicator.style.display = 'block';
                    }
                });
            } else {
                selectRangeBtn.textContent = 'ğŸ” é€‰æ‹©èŒƒå›´';
                selectRangeBtn.style.background = '#FF9500';
                selectionInfo.style.display = 'none';
                
                // éšè—é€‰æ‹©æŒ‡ç¤ºå™¨
                document.querySelectorAll('.message-item').forEach(item => {
                    const indicator = item.querySelector('.selection-indicator');
                    if (indicator) {
                        indicator.style.display = 'none';
                    }
                });
            }
        }

        // åˆ‡æ¢æ¶ˆæ¯é€‰æ‹©çŠ¶æ€
        function toggleMessageSelection(element) {
            if (!isRangeSelectionMode) return;
            
            const index = parseInt(element.dataset.index);
            const indicator = element.querySelector('.selection-indicator');
            
            if (selectedMessages.includes(index)) {
                // å–æ¶ˆé€‰æ‹©
                selectedMessages = selectedMessages.filter(i => i !== index);
                element.style.background = '#ffffff';
                indicator.style.background = 'white';
                indicator.style.border = '2px solid #ddd';
            } else {
                // é€‰æ‹©
                selectedMessages.push(index);
                element.style.background = '#e3f2fd';
                indicator.style.background = '#007AFF';
                indicator.style.border = '2px solid #007AFF';
            }
            
            updateSelectionInfo();
        }

        // æ›´æ–°é€‰æ‹©ä¿¡æ¯
        function updateSelectionInfo() {
            const selectedCount = document.getElementById('selectedCount');
            const generateSummaryBtn = document.getElementById('generateSummaryBtn');
            
            selectedCount.textContent = selectedMessages.length;
            generateSummaryBtn.disabled = selectedMessages.length === 0;
            
            if (selectedMessages.length > 0) {
                generateSummaryBtn.style.background = '#34C759';
                generateSummaryBtn.style.cursor = 'pointer';
            } else {
                generateSummaryBtn.style.background = '#ccc';
                generateSummaryBtn.style.cursor = 'not-allowed';
            }
        }

        // ç”Ÿæˆé€‰å®šæ¶ˆæ¯çš„æ‘˜è¦ - ä½¿ç”¨ContentRenderer
        async function generateSelectedSummary() {
            if (selectedMessages.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ†æçš„æ¶ˆæ¯');
                return;
            }
            
            const summaryResultArea = document.getElementById('summaryResultArea');
            summaryResultArea.style.display = 'block';
            summaryResultArea.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #34C759;">
                    <h4 style="margin: 0 0 15px 0; color: #34C759;">ğŸ“ AIæ‘˜è¦ç”Ÿæˆä¸­...</h4>
                    <p style="color: #007AFF;">æ­£åœ¨åˆ†æé€‰å®šçš„ ${selectedMessages.length} æ¡æ¶ˆæ¯...</p>
                </div>
            `;
            
            try {
                const result = await ipcRenderer.invoke('api-call', {
                    endpoint: '/api/generate-summary',
                    method: 'POST',
                    data: {
                        chat_data: selectedMessages.map(index => currentChatData[index])
                    }
                });
                
                let summaryText = '';
                if (result && result.data && result.data.summary) {
                    summaryText = result.data.summary;
                } else if (result && result.summary) {
                    summaryText = result.summary;
                } else if (result && typeof result === 'string') {
                    summaryText = result;
                } else {
                    summaryText = 'æœªæ”¶åˆ°æ‘˜è¦å†…å®¹\n\nè°ƒè¯•ä¿¡æ¯ï¼š\n' + JSON.stringify(result, null, 2);
                }
                
                // ç¡®ä¿ContentRendererå·²åˆå§‹åŒ–
                if (!contentRenderer) {
                    initRenderer();
                }
                
                // åˆ›å»ºå†…å®¹å®¹å™¨
                const contentContainer = document.createElement('div');
                contentContainer.style.cssText = 'line-height: 1.6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;';
                
                // ä½¿ç”¨ContentRendereræ¸²æŸ“å†…å®¹
                if (summaryText && !summaryText.includes('æœªæ”¶åˆ°æ‘˜è¦å†…å®¹')) {
                    const waitForRenderer = () => {
                        if (contentRenderer && contentRenderer.markedReady) {
                            contentRenderer.renderToElement(summaryText, contentContainer);
                        } else {
                            setTimeout(waitForRenderer, 100);
                        }
                    };
                    waitForRenderer();
                } else {
                    contentContainer.style.whiteSpace = 'pre-wrap';
                    contentContainer.textContent = summaryText;
                }
                
                // æ˜¾ç¤ºæ‘˜è¦ç»“æœ
                summaryResultArea.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #34C759;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #34C759;">ğŸ“ AIæ‘˜è¦ç»“æœ</h4>
                            <div>
                                <button onclick="exportSummary('${summaryText.replace(/'/g, "\\'")}'', 'selected_summary')" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 10px;">
                                    ğŸ’¾ å¯¼å‡ºæ‘˜è¦
                                </button>
                                <button onclick="copyToClipboard('${summaryText.replace(/'/g, "\\'")}'', 'selected_summary')" style="padding: 6px 12px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    ğŸ“‹ å¤åˆ¶å†…å®¹
                                </button>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 10px;">
                            <small style="color: #666;">åŸºäºé€‰å®šçš„ ${selectedMessages.length} æ¡æ¶ˆæ¯ç”Ÿæˆ</small>
                        </div>
                    </div>
                `;
                
                // å°†æ¸²æŸ“å¥½çš„å†…å®¹æ·»åŠ åˆ°ç»“æœåŒºåŸŸ
                summaryResultArea.querySelector('div').appendChild(contentContainer);
                
                // æ»šåŠ¨åˆ°æ‘˜è¦ç»“æœ
                summaryResultArea.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('ç”Ÿæˆæ‘˜è¦å¤±è´¥:', error);
                summaryResultArea.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #FF3B30;">
                        <h4 style="margin: 0 0 10px 0; color: #FF3B30;">âŒ ç”Ÿæˆå¤±è´¥</h4>
                        <p>æ‘˜è¦ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åé‡è¯•ã€‚</p>
                    </div>
                `;
            }
        }

        // AIæ‘˜è¦åŠŸèƒ½ - ä½¿ç”¨ContentRendererè¿›è¡ŒMarkdownæ¸²æŸ“
        async function generateAISummary() {
            console.log('ğŸš€ generateAISummary å‡½æ•°è¢«è°ƒç”¨äº†ï¼');
            
            if (!currentChatData) {
                console.log('âŒ æ²¡æœ‰å¯ç”¨çš„èŠå¤©æ•°æ®');
                alert('æ²¡æœ‰å¯ç”¨çš„èŠå¤©æ•°æ®');
                return;
            }
            
            console.log('âœ… æœ‰èŠå¤©æ•°æ®ï¼Œå¼€å§‹ç”Ÿæˆæ‘˜è¦...');
            
            const resultsDiv = document.getElementById('analysisResults');
            resultsDiv.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #34C759;">
                    <h4 style="margin: 0 0 10px 0; color: #34C759;">ğŸ“ AIæ‘˜è¦</h4>
                    <p style="color: #007AFF;">æ­£åœ¨ç”Ÿæˆæ™ºèƒ½æ‘˜è¦...</p>
                </div>
            `;
            
            try {
                console.log('ğŸ“¡ å‡†å¤‡è°ƒç”¨APIï¼Œæ•°æ®:', currentChatData);
                const result = await ipcRenderer.invoke('api-call', {
                    endpoint: '/api/generate-summary',
                    method: 'POST',
                    data: {
                        chat_data: currentChatData
                    }
                });
                
                console.log('ğŸ“¥ APIè¿”å›ç»“æœ:', result);
                
                // è·å–æ‘˜è¦æ–‡æœ¬
                let summaryText = '';
                if (result && result.data && result.data.summary) {
                    summaryText = result.data.summary;
                } else if (result && result.summary) {
                    summaryText = result.summary;
                } else if (result && typeof result === 'string') {
                    summaryText = result;
                } else {
                    summaryText = 'æœªæ”¶åˆ°æ‘˜è¦å†…å®¹\n\nè°ƒè¯•ä¿¡æ¯ï¼š\n' + JSON.stringify(result, null, 2);
                }
                
                console.log('Final summary text:', summaryText);
                
                // ç¡®ä¿ContentRendererå·²åˆå§‹åŒ–
                if (!contentRenderer) {
                    console.log('åˆå§‹åŒ–ContentRenderer...');
                    initRenderer();
                }
                
                // åˆ›å»ºæ‘˜è¦å®¹å™¨
                const summaryContainer = document.createElement('div');
                summaryContainer.style.cssText = 'background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #34C759;';
                
                // åˆ›å»ºæ ‡é¢˜å’ŒæŒ‰é’®åŒºåŸŸ
                const headerDiv = document.createElement('div');
                headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;';
                
                const titleElement = document.createElement('h4');
                titleElement.style.cssText = 'margin: 0; color: #34C759;';
                titleElement.textContent = 'ğŸ“ AIæ‘˜è¦ç»“æœ';
                
                const buttonContainer = document.createElement('div');
                
                // åˆ›å»ºå¯¼å‡ºæŒ‰é’®
                const exportButton = document.createElement('button');
                exportButton.style.cssText = `
                    padding: 8px 16px; 
                    background: #28a745; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer;
                    margin-right: 10px;
                    font-size: 12px;
                `;
                exportButton.textContent = 'ğŸ’¾ å¯¼å‡ºæ‘˜è¦';
                exportButton.onclick = () => exportSummary(summaryText, 'ai_summary');
                
                // åˆ›å»ºå¤åˆ¶æŒ‰é’®
                const copyButton = document.createElement('button');
                copyButton.style.cssText = `
                    padding: 8px 16px; 
                    background: #007AFF; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer;
                    font-size: 12px;
                `;
                copyButton.textContent = 'ğŸ“‹ å¤åˆ¶å†…å®¹';
                copyButton.onclick = () => copyToClipboard(summaryText);
                
                buttonContainer.appendChild(exportButton);
                buttonContainer.appendChild(copyButton);
                headerDiv.appendChild(titleElement);
                headerDiv.appendChild(buttonContainer);
                summaryContainer.appendChild(headerDiv);
                
                // åˆ›å»ºå†…å®¹å®¹å™¨
                const contentDiv = document.createElement('div');
                contentDiv.style.cssText = 'line-height: 1.6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;';
                
                // ä½¿ç”¨ContentRendereræ¸²æŸ“Markdownå†…å®¹
                if (summaryText && !summaryText.includes('æœªæ”¶åˆ°æ‘˜è¦å†…å®¹')) {
                    // ç­‰å¾…ContentRendererå‡†å¤‡å°±ç»ª
                    const waitForRenderer = () => {
                        if (contentRenderer && contentRenderer.markedReady) {
                            console.log('ä½¿ç”¨ContentRendereræ¸²æŸ“Markdownå†…å®¹');
                            contentRenderer.renderToElement(summaryText, contentDiv);
                        } else {
                            console.log('ContentRendereræœªå‡†å¤‡å¥½ï¼Œ100msåé‡è¯•...');
                            setTimeout(waitForRenderer, 100);
                        }
                    };
                    waitForRenderer();
                } else {
                    // å¦‚æœæ²¡æœ‰æœ‰æ•ˆå†…å®¹ï¼Œæ˜¾ç¤ºçº¯æ–‡æœ¬
                    contentDiv.style.whiteSpace = 'pre-wrap';
                    contentDiv.textContent = summaryText;
                }
                
                summaryContainer.appendChild(contentDiv);
                
                // æ›´æ–°æ˜¾ç¤º
                resultsDiv.innerHTML = '';
                resultsDiv.appendChild(summaryContainer);
                
                console.log('Summary display completed');
                
            } catch (error) {
                console.error('ç”Ÿæˆæ‘˜è¦å¤±è´¥:', error);
                resultsDiv.innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF3B30;">
                        <h4 style="margin: 0 0 10px 0; color: #FF3B30;">âŒ ç”Ÿæˆå¤±è´¥</h4>
                        <p>æ‘˜è¦ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åé‡è¯•ã€‚</p>
                    </div>
                `;
            }
        }
        
        // ç®€åŒ–çš„æ ¼å¼åŒ–å‡½æ•°ï¼ˆä½œä¸ºContentRendererçš„åå¤‡æ–¹æ¡ˆï¼‰
        function formatSummaryContent(text) {
            if (!text) return '';
            
            let formatted = text.trim()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // åŸºç¡€æ¢è¡Œå¤„ç†
            formatted = formatted.replace(/\n\n+/g, '<br><br>');
            formatted = formatted.replace(/\n/g, '<br>');
            
            return `<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; white-space: pre-wrap;">${formatted}</div>`;
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showMessage('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007AFF'};
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 300);
            }, 3000);
        }
        
        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // å®Œæ•´è®°å½•åŠŸèƒ½
        function showFullRecord() {
            if (!currentChatData) {
                alert('æ²¡æœ‰å¯ç”¨çš„èŠå¤©æ•°æ®');
                return;
            }
            
            const resultsDiv = document.getElementById('analysisResults');
            
            // æ ¼å¼åŒ–èŠå¤©è®°å½•
            let recordHtml = '';
            currentChatData.forEach((message, index) => {
                const timestamp = new Date(message.timestamp).toLocaleString('zh-CN');
                recordHtml += `
                    <div style="margin-bottom: 10px; padding: 10px; background: ${index % 2 === 0 ? '#f8f9fa' : '#ffffff'}; border-radius: 4px; border-left: 3px solid #007AFF;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                            <strong>${message.sender || 'æœªçŸ¥ç”¨æˆ·'}</strong> - ${timestamp}
                        </div>
                        <div style="line-height: 1.4;">${message.content || message.message || ''}</div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #007AFF;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #007AFF;">ğŸ“‹ å®Œæ•´è®°å½• (å…± ${currentChatData.length} æ¡æ¶ˆæ¯)</h4>
                        <button onclick="exportSummary(getFullRecordText(), 'full_record')" 
                                style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            ğŸ’¾ å¯¼å‡ºè®°å½•
                        </button>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px;">
                        ${recordHtml}
                    </div>
                </div>
            `;
        }

        // å†…å®¹ç­›é€‰åŠŸèƒ½
        function showContentFilter() {
            if (!currentChatData) {
                alert('æ²¡æœ‰å¯ç”¨çš„èŠå¤©æ•°æ®');
                return;
            }
            
            // è·å–æ‰€æœ‰å‘é€è€…
            const senders = [...new Set(currentChatData.map(msg => msg.sender || 'æœªçŸ¥ç”¨æˆ·'))];
            
            const resultsDiv = document.getElementById('analysisResults');
            resultsDiv.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9500;">
                    <h4 style="margin: 0 0 15px 0; color: #FF9500;">ğŸ” å†…å®¹ç­›é€‰</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">å‘é€è€…ç­›é€‰:</label>
                            <select id="senderFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">å…¨éƒ¨å‘é€è€…</option>
                                ${senders.map(sender => `<option value="${sender}">${sender}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">å…³é”®è¯æœç´¢:</label>
                            <input type="text" id="keywordFilter" placeholder="è¾“å…¥å…³é”®è¯..." 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¼€å§‹æ—¶é—´:</label>
                            <input type="datetime-local" id="startTimeFilter" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç»“æŸæ—¶é—´:</label>
                            <input type="datetime-local" id="endTimeFilter" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 15px;">
                        <button onclick="applyFilters()" style="padding: 10px 20px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                            ğŸ” åº”ç”¨ç­›é€‰
                        </button>
                        <button onclick="clearFilters()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ğŸ”„ æ¸…é™¤ç­›é€‰
                        </button>
                    </div>
                    
                    <div id="filterResults" style="border-top: 1px solid #e9ecef; padding-top: 15px;">
                        <p style="color: #666; text-align: center;">è¯·è®¾ç½®ç­›é€‰æ¡ä»¶å¹¶ç‚¹å‡»"åº”ç”¨ç­›é€‰"</p>
                    </div>
                </div>
            `;
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const sender = document.getElementById('senderFilter').value;
            const keyword = document.getElementById('keywordFilter').value;
            const startTime = document.getElementById('startTimeFilter').value;
            const endTime = document.getElementById('endTimeFilter').value;
            
            let filteredData = [...currentChatData];
            
            // æŒ‰å‘é€è€…ç­›é€‰
            if (sender) {
                filteredData = filteredData.filter(msg => msg.sender === sender);
            }
            
            // æŒ‰å…³é”®è¯ç­›é€‰
            if (keyword) {
                filteredData = filteredData.filter(msg => 
                    (msg.content || msg.message || '').toLowerCase().includes(keyword.toLowerCase())
                );
            }
            
            // æŒ‰æ—¶é—´ç­›é€‰
            if (startTime) {
                const startDate = new Date(startTime);
                filteredData = filteredData.filter(msg => new Date(msg.timestamp) >= startDate);
            }
            
            if (endTime) {
                const endDate = new Date(endTime);
                filteredData = filteredData.filter(msg => new Date(msg.timestamp) <= endDate);
            }
            
            // æ˜¾ç¤ºç­›é€‰ç»“æœ
            displayFilterResults(filteredData);
        }

        // æ˜¾ç¤ºç­›é€‰ç»“æœ
        function displayFilterResults(filteredData) {
            const filterResults = document.getElementById('filterResults');
            
            if (filteredData.length === 0) {
                filterResults.innerHTML = `
                    <p style="color: #FF3B30; text-align: center;">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ¶ˆæ¯</p>
                `;
                return;
            }
            
            let resultHtml = `
                <div style="margin-bottom: 10px; font-weight: bold; color: #FF9500;">
                    ç­›é€‰ç»“æœ: å…±æ‰¾åˆ° ${filteredData.length} æ¡æ¶ˆæ¯
                    <button onclick="exportFilteredData()" style="float: right; padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        ğŸ’¾ å¯¼å‡ºç­›é€‰ç»“æœ
                    </button>
                </div>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px;">
            `;
            
            filteredData.forEach((message, index) => {
                const timestamp = new Date(message.timestamp).toLocaleString('zh-CN');
                resultHtml += `
                    <div style="margin-bottom: 8px; padding: 8px; background: ${index % 2 === 0 ? '#f8f9fa' : '#ffffff'}; border-radius: 4px; border-left: 2px solid #FF9500;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">
                            <strong>${message.sender || 'æœªçŸ¥ç”¨æˆ·'}</strong> - ${timestamp}
                        </div>
                        <div style="font-size: 13px; line-height: 1.3;">${message.content || message.message || ''}</div>
                    </div>
                `;
            });
            
            resultHtml += '</div>';
            filterResults.innerHTML = resultHtml;
            
            // å­˜å‚¨ç­›é€‰ç»“æœä¾›å¯¼å‡ºä½¿ç”¨
            window.currentFilteredData = filteredData;
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            document.getElementById('senderFilter').value = '';
            document.getElementById('keywordFilter').value = '';
            document.getElementById('startTimeFilter').value = '';
            document.getElementById('endTimeFilter').value = '';
            document.getElementById('filterResults').innerHTML = `
                <p style="color: #666; text-align: center;">è¯·è®¾ç½®ç­›é€‰æ¡ä»¶å¹¶ç‚¹å‡»"åº”ç”¨ç­›é€‰"</p>
            `;
            window.currentFilteredData = null;
        }

        // è·å–å®Œæ•´è®°å½•æ–‡æœ¬
        function getFullRecordText() {
            if (!currentChatData) return '';
            
            let text = `èŠå¤©è®°å½•å®Œæ•´å¯¼å‡º\næ–‡ä»¶: ${currentFilePath}\nå¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n\n`;
            text += '='.repeat(50) + '\n\n';
            
            currentChatData.forEach(message => {
                const timestamp = new Date(message.timestamp).toLocaleString('zh-CN');
                text += `[${timestamp}] ${message.sender || 'æœªçŸ¥ç”¨æˆ·'}: ${message.content || message.message || ''}\n\n`;
            });
            
            return text;
        }

        // å¯¼å‡ºç­›é€‰æ•°æ®
        function exportFilteredData() {
            if (!window.currentFilteredData) {
                alert('æ²¡æœ‰ç­›é€‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            let text = `èŠå¤©è®°å½•ç­›é€‰ç»“æœå¯¼å‡º\næ–‡ä»¶: ${currentFilePath}\nå¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n`;
            text += `ç­›é€‰ç»“æœ: ${window.currentFilteredData.length} æ¡æ¶ˆæ¯\n\n`;
            text += '='.repeat(50) + '\n\n';
            
            window.currentFilteredData.forEach(message => {
                const timestamp = new Date(message.timestamp).toLocaleString('zh-CN');
                text += `[${timestamp}] ${message.sender || 'æœªçŸ¥ç”¨æˆ·'}: ${message.content || message.message || ''}\n\n`;
            });
            
            exportSummary(text, 'filtered_data');
        }

        // å¯¼å‡ºåŠŸèƒ½
        async function exportSummary(content, type) {
            try {
                const result = await ipcRenderer.invoke('api-call', {
                    endpoint: '/api/export-summary',
                    method: 'POST',
                    data: {
                        summary: content,
                        export_path: null // ä½¿ç”¨é»˜è®¤è·¯å¾„
                    }
                });
                
                if (!result.ok) {
                    throw new Error(`HTTP error! status: ${result.status}`);
                }
                
                const data = result.data;
                
                if (data.success) {
                    alert(`å¯¼å‡ºæˆåŠŸï¼\næ–‡ä»¶ä¿å­˜è‡³: ${data.file_path}`);
                } else {
                    alert('å¯¼å‡ºå¤±è´¥');
                }
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }
        
        function displayScanResults(data) {
            const results = document.getElementById('results');
            results.innerHTML = `
                <h3>æ‰«æç»“æœ</h3>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #34C759;">
                    <h4 style="margin: 0 0 10px 0; color: #34C759;">ğŸ“Š æ‰«æç»Ÿè®¡</h4>
                    <p style="margin: 5px 0;"><strong>å‘ç°æ–‡ä»¶:</strong> ${data.files_found || 0} ä¸ª</p>
                    <p style="margin: 5px 0;"><strong>æ€»æ¶ˆæ¯æ•°:</strong> ${data.total_messages || 0}</p>
                    <p style="margin: 5px 0;"><strong>æ‰«æè·¯å¾„:</strong> ${data.scan_paths?.join(', ') || 'æ— '}</p>
                </div>
                
                ${data.summary ? `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #007AFF;">
                    <h4 style="margin: 0 0 10px 0; color: #007AFF;">ğŸ“ æ•´ä½“æ‘˜è¦</h4>
                    <p style="line-height: 1.6; margin: 0;">${data.summary}</p>
                </div>
                ` : ''}
                
                ${data.files && data.files.length > 0 ? `
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9500;">
                    <h4 style="margin: 0 0 10px 0; color: #FF9500;">ğŸ“ å‘ç°çš„æ–‡ä»¶</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${data.files.map(file => `<li style="margin: 5px 0;">${file}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
            `;
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoChat - AIæ™ºèƒ½èŠå¤©æ‘˜è¦</title>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }
        #root {
            height: 100vh;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">æ­£åœ¨åŠ è½½ MemoChat...</div>
    </div>
    
    <script>
        const { ipcRenderer } = require('electron');
        
        let initializationChecked = false;
        
        // é¡µé¢å¯¼èˆªç³»ç»Ÿ
        let pageHistory = [];
        let currentPage = null;
        
        // æ·»åŠ é¡µé¢åˆ°å†å²è®°å½•
        function addToHistory(pageName, pageData = null) {
            if (currentPage && currentPage !== pageName) {
                pageHistory.push({
                    name: currentPage,
                    data: pageData
                });
            }
            currentPage = pageName;
            updateBackButton();
        }
        
        // æ›´æ–°è¿”å›æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        function updateBackButton() {
            const backButton = document.getElementById('backButton');
            if (backButton) {
                if (pageHistory.length > 0) {
                    backButton.style.display = 'inline-block';
                } else {
                    backButton.style.display = 'none';
                }
            }
        }
        
        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            if (pageHistory.length > 0) {
                const previousPage = pageHistory.pop();
                currentPage = previousPage.name;
                
                // æ ¹æ®é¡µé¢ç±»å‹è°ƒç”¨ç›¸åº”çš„æ˜¾ç¤ºå‡½æ•°
                switch (previousPage.name) {
                    case 'main':
                        showMainApp();
                        break;
                    case 'initialization':
                        showInitializationWizard();
                        break;
                    default:
                        showMainApp();
                        break;
                }
                
                updateBackButton();
            }
        }
        
        // åˆ›å»ºè¿”å›æŒ‰é’®HTML
        function createBackButton() {
            return `
                <button id="backButton" onclick="goBack()" 
                        style="position: absolute; top: 20px; left: 20px; padding: 8px 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; display: none; z-index: 1000;">
                    â† è¿”å›
                </button>
            `;
        }

        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, checking initialization status...');
            checkInitializationStatus();
        });
        
        // ä¸»åŠ¨æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€
        async function checkInitializationStatus() {
            if (initializationChecked) return;
            initializationChecked = true;
            
            try {
                // è·å–é…ç½®ä¿¡æ¯
                const config = await ipcRenderer.invoke('get-config');
                console.log('Config loaded:', config);
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ–
                const needsInit = !config.api.key || 
                                 (!config.chatRecords.wechat.mac && !config.chatRecords.wechat.windows &&
                                  !config.chatRecords.qq.mac && !config.chatRecords.qq.windows);
                
                console.log('Needs initialization:', needsInit);
                
                if (needsInit) {
                    showInitializationWizard();
                } else {
                    showMainApp();
                }
            } catch (error) {
                console.error('Failed to check initialization status:', error);
                // å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œé»˜è®¤æ˜¾ç¤ºåˆå§‹åŒ–ç•Œé¢
                showInitializationWizard();
            }
        }
        
        // ç›‘å¬æ¥è‡ªä¸»è¿›ç¨‹çš„åˆå§‹åŒ–çŠ¶æ€ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        ipcRenderer.on('initialization-status', (event, data) => {
            console.log('Received initialization status:', data);
            if (!initializationChecked) {
                initializationChecked = true;
                if (data.needsInitialization) {
                    showInitializationWizard();
                } else {
                    showMainApp();
                }
            }
        });
        
        function showInitializationWizard() {
            console.log('Showing initialization wizard');
            addToHistory('initialization');
            
            const root = document.getElementById('root');
            root.innerHTML = `
                ${createBackButton()}
                <div style="padding: 40px; max-width: 600px; margin: 0 auto;">
                    <h1 style="text-align: center; color: #333;">æ¬¢è¿ä½¿ç”¨ MemoChat</h1>
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h2>åˆå§‹åŒ–è®¾ç½®</h2>
                        <p>è¯·å®Œæˆä»¥ä¸‹è®¾ç½®ä»¥å¼€å§‹ä½¿ç”¨ MemoChatï¼š</p>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">API å¯†é’¥ï¼š</label>
                            <input type="text" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„é€šä¹‰åƒé—®APIå¯†é’¥" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">èŠå¤©è®°å½•è·¯å¾„ï¼š</label>
                            <button onclick="selectChatPath()" 
                                    style="padding: 10px 20px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                é€‰æ‹©èŠå¤©è®°å½•ç›®å½•
                            </button>
                            <div id="selectedPath" style="margin-top: 10px; color: #666;"></div>
                        </div>
                        
                        <button onclick="completeSetup()" 
                                style="width: 100%; padding: 12px; background: #34C759; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
                            å®Œæˆè®¾ç½®
                        </button>
                    </div>
                </div>
            `;
            updateBackButton();
        }
        
        function showMainApp() {
            console.log('Showing main app');
            addToHistory('main');
            
            const root = document.getElementById('root');
            root.innerHTML = `
                ${createBackButton()}
                <div style="padding: 20px; height: 100vh; display: flex; flex-direction: column; position: relative;">
                    <header style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h1 style="margin: 0; color: #333;">MemoChat - AIæ™ºèƒ½èŠå¤©æ‘˜è¦</h1>
                        <p style="margin: 10px 0 0 0; color: #666;">æ™ºèƒ½åˆ†ææ‚¨çš„èŠå¤©è®°å½•ï¼Œç”Ÿæˆä¸“ä¸šæ‘˜è¦</p>
                    </header>
                    
                    <div style="flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h2>åŠŸèƒ½åŒºåŸŸ</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>ğŸ“ æ–‡ä»¶ä¸Šä¼ </h3>
                                <p>ä¸Šä¼ èŠå¤©è®°å½•æ–‡ä»¶è¿›è¡Œåˆ†æ</p>
                                <button onclick="uploadFile()" style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    é€‰æ‹©æ–‡ä»¶
                                </button>
                            </div>
                            
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>ğŸ” è·¯å¾„æ‰«æ</h3>
                                <p>è‡ªåŠ¨æ‰«ææœ¬åœ°èŠå¤©è®°å½•</p>
                                <button onclick="scanChats()" style="padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    å¼€å§‹æ‰«æ
                                </button>
                            </div>
                            
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>âš™ï¸ è®¾ç½®</h3>
                                <p>ä¿®æ”¹åº”ç”¨é…ç½®å’ŒAPIå¯†é’¥</p>
                                <button onclick="openSettings()" style="padding: 8px 16px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    æ‰“å¼€è®¾ç½®
                                </button>
                            </div>
                        </div>
                        
                        <div id="results" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 200px;">
                            <h3>åˆ†æç»“æœ</h3>
                            <p style="color: #666;">è¯·é€‰æ‹©ä¸Šè¿°åŠŸèƒ½å¼€å§‹ä½¿ç”¨ MemoChat</p>
                        </div>
                    </div>
                </div>
            `;
            updateBackButton();
        }
        
        async function selectChatPath() {
            try {
                const path = await ipcRenderer.invoke('select-directory');
                if (path) {
                    document.getElementById('selectedPath').textContent = `å·²é€‰æ‹©: ${path}`;
                    window.selectedChatPath = path;
                }
            } catch (error) {
                alert('é€‰æ‹©ç›®å½•å¤±è´¥: ' + error.message);
            }
        }
        
        async function completeSetup() {
            const apiKey = document.getElementById('apiKey').value;
            const chatPath = window.selectedChatPath;
            
            if (!apiKey) {
                alert('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }
            
            if (!chatPath) {
                alert('è¯·é€‰æ‹©èŠå¤©è®°å½•è·¯å¾„');
                return;
            }
            
            try {
                const result = await ipcRenderer.invoke('complete-initialization', {
                    apiKey: apiKey,
                    chatPaths: {
                        wechat: chatPath,
                        qq: chatPath
                    }
                });
                
                if (result.success) {
                    alert('è®¾ç½®å®Œæˆï¼');
                    showMainApp();
                } else {
                    alert('è®¾ç½®å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }
        
        // ä¸»åº”ç”¨åŠŸèƒ½å‡½æ•°
        async function uploadFile() {
            try {
                const filePath = await ipcRenderer.invoke('select-file');
                if (filePath) {
                    document.getElementById('results').innerHTML = `
                        <h3>åˆ†æç»“æœ</h3>
                        <p>å·²é€‰æ‹©æ–‡ä»¶: ${filePath}</p>
                        <p style="color: #007AFF;">æ­£åœ¨åˆ†æä¸­...</p>
                    `;
                    
                    // è°ƒç”¨åç«¯APIåˆ†ææ–‡ä»¶
                    try {
                        const response = await fetch('http://127.0.0.1:5000/api/load-chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                file_path: filePath
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // æ˜¾ç¤ºåˆ†æç»“æœ
                        displayChatAnalysis(data, filePath);
                        
                    } catch (apiError) {
                        console.error('APIè°ƒç”¨å¤±è´¥:', apiError);
                        document.getElementById('results').innerHTML = `
                            <h3>åˆ†æç»“æœ</h3>
                            <p>å·²é€‰æ‹©æ–‡ä»¶: ${filePath}</p>
                            <p style="color: #FF3B30;">åˆ†æå¤±è´¥: ${apiError.message}</p>
                            <p style="color: #666;">è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œæˆ–ç¨åé‡è¯•ã€‚</p>
                        `;
                    }
                }
            } catch (error) {
                alert('æ–‡ä»¶é€‰æ‹©å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºèŠå¤©åˆ†æç»“æœ
        function displayChatAnalysis(data, filePath) {
            addToHistory('analysis');
            
            const { chat_data, contacts } = data;
            const messageCount = chat_data.length;
            const contactList = Array.from(contacts).join(', ');
            
            // è·å–æ—¶é—´èŒƒå›´
            let timeRange = '';
            if (messageCount > 0) {
                const firstMessage = new Date(chat_data[0].timestamp);
                const lastMessage = new Date(chat_data[messageCount - 1].timestamp);
                timeRange = `${firstMessage.toLocaleDateString()} - ${lastMessage.toLocaleDateString()}`;
            }
            
            document.getElementById('results').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">åˆ†æç»“æœ</h3>
                    <button onclick="clearResults()" style="padding: 6px 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        æ¸…é™¤ç»“æœ
                    </button>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #34C759;">âœ… æ–‡ä»¶è§£ææˆåŠŸ</h4>
                    <p><strong>æ–‡ä»¶è·¯å¾„:</strong> ${filePath}</p>
                    <p><strong>æ¶ˆæ¯æ•°é‡:</strong> ${messageCount} æ¡</p>
                    <p><strong>å‚ä¸äººå‘˜:</strong> ${contactList}</p>
                    <p><strong>æ—¶é—´èŒƒå›´:</strong> ${timeRange}</p>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="generateSummary()" style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ç”ŸæˆAIæ‘˜è¦
                    </button>
                    <button onclick="showChatDetails()" style="padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        æŸ¥çœ‹è¯¦ç»†å†…å®¹
                    </button>
                    <button onclick="filterChat()" style="padding: 8px 16px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ç­›é€‰æ¶ˆæ¯
                    </button>
                </div>
                
                <div id="detailsArea" style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    <p style="color: #666;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹æ›´å¤šè¯¦ç»†ä¿¡æ¯æˆ–ç”ŸæˆAIæ‘˜è¦</p>
                </div>
            `;
            
            // ä¿å­˜æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
            window.currentChatData = chat_data;
            window.currentContacts = contacts;
            updateBackButton();
        }
        
        // ç”ŸæˆAIæ‘˜è¦
        async function generateSummary() {
            if (!window.currentChatData) {
                alert('è¯·å…ˆé€‰æ‹©å¹¶åˆ†æèŠå¤©æ–‡ä»¶');
                return;
            }
            
            document.getElementById('detailsArea').innerHTML = `
                <p style="color: #007AFF;">æ­£åœ¨ç”ŸæˆAIæ‘˜è¦ï¼Œè¯·ç¨å€™...</p>
            `;
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/generate-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_data: window.currentChatData
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                document.getElementById('detailsArea').innerHTML = `
                    <h4 style="margin: 0 0 10px 0; color: #007AFF;">ğŸ¤– AIç”Ÿæˆæ‘˜è¦</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${data.summary}</div>
                    <button onclick="exportSummary('${data.summary}')" style="margin-top: 10px; padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        å¯¼å‡ºæ‘˜è¦
                    </button>
                `;
                
            } catch (error) {
                console.error('ç”Ÿæˆæ‘˜è¦å¤±è´¥:', error);
                document.getElementById('detailsArea').innerHTML = `
                    <p style="color: #FF3B30;">ç”Ÿæˆæ‘˜è¦å¤±è´¥: ${error.message}</p>
                    <p style="color: #666;">è¯·æ£€æŸ¥APIå¯†é’¥é…ç½®æˆ–ç½‘ç»œè¿æ¥ã€‚</p>
                `;
            }
        }
        
        // æ˜¾ç¤ºèŠå¤©è¯¦ç»†å†…å®¹
        function showChatDetails() {
            if (!window.currentChatData) {
                alert('è¯·å…ˆé€‰æ‹©å¹¶åˆ†æèŠå¤©æ–‡ä»¶');
                return;
            }
            
            const messages = window.currentChatData.slice(0, 50); // åªæ˜¾ç¤ºå‰50æ¡æ¶ˆæ¯
            let html = `
                <h4 style="margin: 0 0 10px 0; color: #34C759;">ğŸ’¬ èŠå¤©è®°å½•è¯¦æƒ… (æ˜¾ç¤ºå‰50æ¡)</h4>
                <div style="background: white; padding: 15px; border-radius: 8px;">
            `;
            
            messages.forEach(msg => {
                const time = new Date(msg.timestamp).toLocaleString();
                html += `
                    <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #007AFF; background: #f9f9f9;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 3px;">
                            ${msg.sender} - ${time}
                        </div>
                        <div>${msg.content}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (window.currentChatData.length > 50) {
                html += `<p style="color: #666; margin-top: 10px;">è¿˜æœ‰ ${window.currentChatData.length - 50} æ¡æ¶ˆæ¯æœªæ˜¾ç¤º</p>`;
            }
            
            document.getElementById('detailsArea').innerHTML = html;
        }
        
        // ç­›é€‰èŠå¤©è®°å½•
        function filterChat() {
            if (!window.currentChatData) {
                alert('è¯·å…ˆé€‰æ‹©å¹¶åˆ†æèŠå¤©æ–‡ä»¶');
                return;
            }
            
            const contacts = Array.from(window.currentContacts);
            let contactOptions = contacts.map(contact => `<option value="${contact}">${contact}</option>`).join('');
            
            document.getElementById('detailsArea').innerHTML = `
                <h4 style="margin: 0 0 15px 0; color: #FF9500;">ğŸ” ç­›é€‰èŠå¤©è®°å½•</h4>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æŒ‰å‘é€è€…ç­›é€‰:</label>
                        <select id="senderFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">å…¨éƒ¨å‘é€è€…</option>
                            ${contactOptions}
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¼€å§‹æ—¶é—´:</label>
                            <input type="datetime-local" id="startTime" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç»“æŸæ—¶é—´:</label>
                            <input type="datetime-local" id="endTime" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <button onclick="applyFilter()" style="width: 100%; padding: 10px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        åº”ç”¨ç­›é€‰
                    </button>
                </div>
            `;
        }
        
        // åº”ç”¨ç­›é€‰æ¡ä»¶
        async function applyFilter() {
            const sender = document.getElementById('senderFilter').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/filter-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_data: window.currentChatData,
                        sender: sender || undefined,
                        start_time: startTime || undefined,
                        end_time: endTime || undefined
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const filteredData = data.filtered_data;
                let html = `
                    <h4 style="margin: 0 0 10px 0; color: #FF9500;">ğŸ” ç­›é€‰ç»“æœ (${filteredData.length} æ¡æ¶ˆæ¯)</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                `;
                
                if (filteredData.length === 0) {
                    html += '<p style="color: #666;">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ¶ˆæ¯</p>';
                } else {
                    filteredData.slice(0, 30).forEach(msg => {
                        const time = new Date(msg.timestamp).toLocaleString();
                        html += `
                            <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #FF9500; background: #f9f9f9;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">
                                    ${msg.sender} - ${time}
                                </div>
                                <div>${msg.content}</div>
                            </div>
                        `;
                    });
                    
                    if (filteredData.length > 30) {
                        html += `<p style="color: #666; margin-top: 10px;">è¿˜æœ‰ ${filteredData.length - 30} æ¡æ¶ˆæ¯æœªæ˜¾ç¤º</p>`;
                    }
                }
                
                html += '</div>';
                
                document.getElementById('detailsArea').innerHTML = html;
                
            } catch (error) {
                console.error('ç­›é€‰å¤±è´¥:', error);
                document.getElementById('detailsArea').innerHTML = `
                    <p style="color: #FF3B30;">ç­›é€‰å¤±è´¥: ${error.message}</p>
                `;
            }
        }
        
        // å¯¼å‡ºæ‘˜è¦
        async function exportSummary(summary) {
            try {
                const response = await fetch('http://127.0.0.1:5000/api/export-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        summary: summary
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                alert(`æ‘˜è¦å·²å¯¼å‡ºåˆ°: ${data.file_path}`);
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        }
        async function scanChats() {
            document.getElementById('results').innerHTML = `
                <h3>åˆ†æç»“æœ</h3>
                <p style="color: #007AFF;">æ­£åœ¨æ‰«æèŠå¤©è®°å½•...</p>
            `;
            // TODO: è°ƒç”¨åç«¯APIæ‰«æèŠå¤©è®°å½•
        }
        
        function openSettings() {
            addToHistory('settings');
            showInitializationWizard();
        }

        // æ˜¾ç¤ºèŠå¤©åˆ†æç»“æœ
        function displayChatAnalysis(data, filePath) {
            addToHistory('analysis');
            
            const { chat_data, contacts } = data;
            const messageCount = chat_data.length;
            const contactList = Array.from(contacts).join(', ');
            
            // è·å–æ—¶é—´èŒƒå›´
            let timeRange = '';
            if (messageCount > 0) {
                const firstMessage = new Date(chat_data[0].timestamp);
                const lastMessage = new Date(chat_data[messageCount - 1].timestamp);
                timeRange = `${firstMessage.toLocaleDateString()} - ${lastMessage.toLocaleDateString()}`;
            }
            
            document.getElementById('results').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">åˆ†æç»“æœ</h3>
                    <button onclick="clearResults()" style="padding: 6px 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        æ¸…é™¤ç»“æœ
                    </button>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #34C759;">âœ… æ–‡ä»¶è§£ææˆåŠŸ</h4>
                    <p><strong>æ–‡ä»¶è·¯å¾„:</strong> ${filePath}</p>
                    <p><strong>æ¶ˆæ¯æ•°é‡:</strong> ${messageCount} æ¡</p>
                    <p><strong>å‚ä¸äººå‘˜:</strong> ${contactList}</p>
                    <p><strong>æ—¶é—´èŒƒå›´:</strong> ${timeRange}</p>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="generateSummary()" style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ç”ŸæˆAIæ‘˜è¦
                    </button>
                    <button onclick="showChatDetails()" style="padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        æŸ¥çœ‹è¯¦ç»†å†…å®¹
                    </button>
                    <button onclick="filterChat()" style="padding: 8px 16px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ç­›é€‰æ¶ˆæ¯
                    </button>
                </div>
                
                <div id="detailsArea" style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    <p style="color: #666;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹æ›´å¤šè¯¦ç»†ä¿¡æ¯æˆ–ç”ŸæˆAIæ‘˜è¦</p>
                </div>
            `;
            
            // ä¿å­˜æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
            window.currentChatData = chat_data;
            window.currentContacts = contacts;
            updateBackButton();
        }
        
        // æ¸…é™¤åˆ†æç»“æœï¼Œè¿”å›ä¸»ç•Œé¢
        function clearResults() {
            document.getElementById('results').innerHTML = `
                <h3>åˆ†æç»“æœ</h3>
                <p style="color: #666;">è¯·é€‰æ‹©ä¸Šè¿°åŠŸèƒ½å¼€å§‹ä½¿ç”¨ MemoChat</p>
            `;
            
            // æ¸…é™¤å…¨å±€æ•°æ®
            window.currentChatData = null;
            window.currentContacts = null;
            
            // ç§»é™¤åˆ†æé¡µé¢çš„å†å²è®°å½•
            if (pageHistory.length > 0 && pageHistory[pageHistory.length - 1].name === 'analysis') {
                pageHistory.pop();
                updateBackButton();
            }
        }

        // ç”ŸæˆAIæ‘˜è¦
        async function generateSummary() {
            if (!window.currentChatData) {
                alert('è¯·å…ˆé€‰æ‹©å¹¶åˆ†æèŠå¤©æ–‡ä»¶');
                return;
            }
            
            document.getElementById('detailsArea').innerHTML = `
                <p style="color: #007AFF;">æ­£åœ¨ç”ŸæˆAIæ‘˜è¦ï¼Œè¯·ç¨å€™...</p>
            `;
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/generate-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_data: window.currentChatData
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                document.getElementById('detailsArea').innerHTML = `
                    <h4 style="margin: 0 0 10px 0; color: #007AFF;">ğŸ¤– AIç”Ÿæˆæ‘˜è¦</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${data.summary}</div>
                    <button onclick="exportSummary('${data.summary}')" style="margin-top: 10px; padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        å¯¼å‡ºæ‘˜è¦
                    </button>
                `;
                
            } catch (error) {
                console.error('ç”Ÿæˆæ‘˜è¦å¤±è´¥:', error);
                document.getElementById('detailsArea').innerHTML = `
                    <p style="color: #FF3B30;">ç”Ÿæˆæ‘˜è¦å¤±è´¥: ${error.message}</p>
                    <p style="color: #666;">è¯·æ£€æŸ¥APIå¯†é’¥é…ç½®æˆ–ç½‘ç»œè¿æ¥ã€‚</p>
                `;
            }
        }
        
        // æ˜¾ç¤ºèŠå¤©è¯¦ç»†å†…å®¹
        function showChatDetails() {
            if (!window.currentChatData) {
                alert('è¯·å…ˆé€‰æ‹©å¹¶åˆ†æèŠå¤©æ–‡ä»¶');
                return;
            }
            
            const messages = window.currentChatData.slice(0, 50); // åªæ˜¾ç¤ºå‰50æ¡æ¶ˆæ¯
            let html = `
                <h4 style="margin: 0 0 10px 0; color: #34C759;">ğŸ’¬ èŠå¤©è®°å½•è¯¦æƒ… (æ˜¾ç¤ºå‰50æ¡)</h4>
                <div style="background: white; padding: 15px; border-radius: 8px;">
            `;
            
            messages.forEach(msg => {
                const time = new Date(msg.timestamp).toLocaleString();
                html += `
                    <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #007AFF; background: #f9f9f9;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 3px;">
                            ${msg.sender} - ${time}
                        </div>
                        <div>${msg.content}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (window.currentChatData.length > 50) {
                html += `<p style="color: #666; margin-top: 10px;">è¿˜æœ‰ ${window.currentChatData.length - 50} æ¡æ¶ˆæ¯æœªæ˜¾ç¤º</p>`;
            }
            
            document.getElementById('detailsArea').innerHTML = html;
        }
        
        // ç­›é€‰èŠå¤©è®°å½•
        function filterChat() {
            if (!window.currentChatData) {
                alert('è¯·å…ˆé€‰æ‹©å¹¶åˆ†æèŠå¤©æ–‡ä»¶');
                return;
            }
            
            const contacts = Array.from(window.currentContacts);
            let contactOptions = contacts.map(contact => `<option value="${contact}">${contact}</option>`).join('');
            
            document.getElementById('detailsArea').innerHTML = `
                <h4 style="margin: 0 0 15px 0; color: #FF9500;">ğŸ” ç­›é€‰èŠå¤©è®°å½•</h4>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æŒ‰å‘é€è€…ç­›é€‰:</label>
                        <select id="senderFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">å…¨éƒ¨å‘é€è€…</option>
                            ${contactOptions}
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¼€å§‹æ—¶é—´:</label>
                            <input type="datetime-local" id="startTime" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç»“æŸæ—¶é—´:</label>
                            <input type="datetime-local" id="endTime" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <button onclick="applyFilter()" style="width: 100%; padding: 10px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        åº”ç”¨ç­›é€‰
                    </button>
                </div>
            `;
        }
        
        // åº”ç”¨ç­›é€‰æ¡ä»¶
        async function applyFilter() {
            const sender = document.getElementById('senderFilter').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/filter-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_data: window.currentChatData,
                        sender: sender || undefined,
                        start_time: startTime || undefined,
                        end_time: endTime || undefined
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const filteredData = data.filtered_data;
                let html = `
                    <h4 style="margin: 0 0 10px 0; color: #FF9500;">ğŸ” ç­›é€‰ç»“æœ (${filteredData.length} æ¡æ¶ˆæ¯)</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                `;
                
                if (filteredData.length === 0) {
                    html += '<p style="color: #666;">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ¶ˆæ¯</p>';
                } else {
                    filteredData.slice(0, 30).forEach(msg => {
                        const time = new Date(msg.timestamp).toLocaleString();
                        html += `
                            <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #FF9500; background: #f9f9f9;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">
                                    ${msg.sender} - ${time}
                                </div>
                                <div>${msg.content}</div>
                            </div>
                        `;
                    });
                    
                    if (filteredData.length > 30) {
                        html += `<p style="color: #666; margin-top: 10px;">è¿˜æœ‰ ${filteredData.length - 30} æ¡æ¶ˆæ¯æœªæ˜¾ç¤º</p>`;
                    }
                }
                
                html += '</div>';
                
                document.getElementById('detailsArea').innerHTML = html;
                
            } catch (error) {
                console.error('ç­›é€‰å¤±è´¥:', error);
                document.getElementById('detailsArea').innerHTML = `
                    <p style="color: #FF3B30;">ç­›é€‰å¤±è´¥: ${error.message}</p>
                `;
            }
        }
        
        // å¯¼å‡ºæ‘˜è¦
        async function exportSummary(summary) {
            try {
                const response = await fetch('http://127.0.0.1:5000/api/export-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        summary: summary
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                alert(`æ‘˜è¦å·²å¯¼å‡ºåˆ°: ${data.file_path}`);
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        }
        async function scanChats() {
            document.getElementById('results').innerHTML = `
                <h3>åˆ†æç»“æœ</h3>
                <p style="color: #007AFF;">æ­£åœ¨æ‰«æèŠå¤©è®°å½•...</p>
            `;
            // TODO: è°ƒç”¨åç«¯APIæ‰«æèŠå¤©è®°å½•
        }
        
        function openSettings() {
            showInitializationWizard();
        }
    </script>
</body>
</html>
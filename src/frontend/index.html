<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoChat - AI智能聊天摘要</title>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }
        #root {
            height: 100vh;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">正在加载 MemoChat...</div>
    </div>
    
    <script>
        const { ipcRenderer } = require('electron');
        
        let initializationChecked = false;
        
        // 页面导航系统
        let pageHistory = [];
        let currentPage = null;
        
        // 添加页面到历史记录
        function addToHistory(pageName, pageData = null) {
            if (currentPage && currentPage !== pageName) {
                pageHistory.push({
                    name: currentPage,
                    data: pageData
                });
            }
            currentPage = pageName;
            updateBackButton();
        }
        
        // 更新返回按钮显示状态
        function updateBackButton() {
            const backButton = document.getElementById('backButton');
            if (backButton) {
                if (pageHistory.length > 0) {
                    backButton.style.display = 'inline-block';
                } else {
                    backButton.style.display = 'none';
                }
            }
        }
        
        // 返回上一页
        function goBack() {
            if (pageHistory.length > 0) {
                const previousPage = pageHistory.pop();
                currentPage = previousPage.name;
                
                // 根据页面类型调用相应的显示函数
                switch (previousPage.name) {
                    case 'main':
                        showMainApp();
                        break;
                    case 'initialization':
                        showInitializationWizard();
                        break;
                    default:
                        showMainApp();
                        break;
                }
                
                updateBackButton();
            }
        }
        
        // 创建返回按钮HTML
        function createBackButton() {
            return `
                <button id="backButton" onclick="goBack()" 
                        style="position: absolute; top: 20px; left: 20px; padding: 8px 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; display: none; z-index: 1000;">
                    ← 返回
                </button>
            `;
        }

        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, checking initialization status...');
            checkInitializationStatus();
        });
        
        // 主动检查初始化状态
        async function checkInitializationStatus() {
            if (initializationChecked) return;
            initializationChecked = true;
            
            try {
                // 获取配置信息
                const config = await ipcRenderer.invoke('get-config');
                console.log('Config loaded:', config);
                
                // 检查是否需要初始化
                const needsInit = !config.api.key || 
                                 (!config.chatRecords.wechat.mac && !config.chatRecords.wechat.windows &&
                                  !config.chatRecords.qq.mac && !config.chatRecords.qq.windows);
                
                console.log('Needs initialization:', needsInit);
                
                if (needsInit) {
                    showInitializationWizard();
                } else {
                    showMainApp();
                }
            } catch (error) {
                console.error('Failed to check initialization status:', error);
                // 如果检查失败，默认显示初始化界面
                showInitializationWizard();
            }
        }
        
        // 监听来自主进程的初始化状态（备用方案）
        ipcRenderer.on('initialization-status', (event, data) => {
            console.log('Received initialization status:', data);
            if (!initializationChecked) {
                initializationChecked = true;
                if (data.needsInitialization) {
                    showInitializationWizard();
                } else {
                    showMainApp();
                }
            }
        });
        
        function showInitializationWizard() {
            console.log('Showing initialization wizard');
            addToHistory('initialization');
            
            const root = document.getElementById('root');
            root.innerHTML = `
                ${createBackButton()}
                <div style="padding: 40px; max-width: 600px; margin: 0 auto;">
                    <h1 style="text-align: center; color: #333;">欢迎使用 MemoChat</h1>
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h2>初始化设置</h2>
                        <p>请完成以下设置以开始使用 MemoChat：</p>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">API 密钥：</label>
                            <input type="text" id="apiKey" placeholder="请输入您的通义千问API密钥" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">聊天记录路径：</label>
                            <button onclick="selectChatPath()" 
                                    style="padding: 10px 20px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                选择聊天记录目录
                            </button>
                            <div id="selectedPath" style="margin-top: 10px; color: #666;"></div>
                        </div>
                        
                        <button onclick="completeSetup()" 
                                style="width: 100%; padding: 12px; background: #34C759; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
                            完成设置
                        </button>
                    </div>
                </div>
            `;
            updateBackButton();
        }
        
        function showMainApp() {
            console.log('Showing main app');
            addToHistory('main');
            
            const root = document.getElementById('root');
            root.innerHTML = `
                ${createBackButton()}
                <div style="padding: 20px; height: 100vh; display: flex; flex-direction: column; position: relative;">
                    <header style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h1 style="margin: 0; color: #333;">MemoChat - AI智能聊天摘要</h1>
                        <p style="margin: 10px 0 0 0; color: #666;">智能分析您的聊天记录，生成专业摘要</p>
                    </header>
                    
                    <div style="flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h2>功能区域</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>📁 文件上传</h3>
                                <p>上传聊天记录文件进行分析</p>
                                <button onclick="uploadFile()" style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    选择文件
                                </button>
                            </div>
                            
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>🔍 路径扫描</h3>
                                <p>自动扫描本地聊天记录</p>
                                <button onclick="scanChats()" style="padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    开始扫描
                                </button>
                            </div>
                            
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>⚙️ 设置</h3>
                                <p>修改应用配置和API密钥</p>
                                <button onclick="openSettings()" style="padding: 8px 16px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    打开设置
                                </button>
                            </div>
                        </div>
                        
                        <div id="results" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 200px;">
                            <h3>分析结果</h3>
                            <p style="color: #666;">请选择上述功能开始使用 MemoChat</p>
                        </div>
                    </div>
                </div>
            `;
            updateBackButton();
        }
        
        async function selectChatPath() {
            try {
                const path = await ipcRenderer.invoke('select-directory');
                if (path) {
                    document.getElementById('selectedPath').textContent = `已选择: ${path}`;
                    window.selectedChatPath = path;
                }
            } catch (error) {
                alert('选择目录失败: ' + error.message);
            }
        }
        
        async function completeSetup() {
            const apiKey = document.getElementById('apiKey').value;
            const chatPath = window.selectedChatPath;
            
            if (!apiKey) {
                alert('请输入API密钥');
                return;
            }
            
            if (!chatPath) {
                alert('请选择聊天记录路径');
                return;
            }
            
            try {
                const result = await ipcRenderer.invoke('complete-initialization', {
                    apiKey: apiKey,
                    chatPaths: {
                        wechat: chatPath,
                        qq: chatPath
                    }
                });
                
                if (result.success) {
                    alert('设置完成！');
                    showMainApp();
                } else {
                    alert('设置失败: ' + result.error);
                }
            } catch (error) {
                alert('设置失败: ' + error.message);
            }
        }
        
        // 主应用功能函数
        async function uploadFile() {
            try {
                const filePath = await ipcRenderer.invoke('select-file');
                if (filePath) {
                    document.getElementById('results').innerHTML = `
                        <h3>分析结果</h3>
                        <p>已选择文件: ${filePath}</p>
                        <p style="color: #007AFF;">正在分析中...</p>
                    `;
                    
                    // 调用后端API分析文件
                    try {
                        const response = await fetch('http://127.0.0.1:5000/api/load-chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                file_path: filePath
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // 显示分析结果
                        displayChatAnalysis(data, filePath);
                        
                    } catch (apiError) {
                        console.error('API调用失败:', apiError);
                        document.getElementById('results').innerHTML = `
                            <h3>分析结果</h3>
                            <p>已选择文件: ${filePath}</p>
                            <p style="color: #FF3B30;">分析失败: ${apiError.message}</p>
                            <p style="color: #666;">请检查文件格式是否正确，或稍后重试。</p>
                        `;
                    }
                }
            } catch (error) {
                alert('文件选择失败: ' + error.message);
            }
        }
        
        // 显示聊天分析结果
        function displayChatAnalysis(data, filePath) {
            addToHistory('analysis');
            
            const { chat_data, contacts } = data;
            const messageCount = chat_data.length;
            const contactList = Array.from(contacts).join(', ');
            
            // 获取时间范围
            let timeRange = '';
            if (messageCount > 0) {
                const firstMessage = new Date(chat_data[0].timestamp);
                const lastMessage = new Date(chat_data[messageCount - 1].timestamp);
                timeRange = `${firstMessage.toLocaleDateString()} - ${lastMessage.toLocaleDateString()}`;
            }
            
            document.getElementById('results').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">分析结果</h3>
                    <button onclick="clearResults()" style="padding: 6px 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        清除结果
                    </button>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #34C759;">✅ 文件解析成功</h4>
                    <p><strong>文件路径:</strong> ${filePath}</p>
                    <p><strong>消息数量:</strong> ${messageCount} 条</p>
                    <p><strong>参与人员:</strong> ${contactList}</p>
                    <p><strong>时间范围:</strong> ${timeRange}</p>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="generateSummary()" style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        生成AI摘要
                    </button>
                    <button onclick="showChatDetails()" style="padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        查看详细内容
                    </button>
                    <button onclick="filterChat()" style="padding: 8px 16px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        筛选消息
                    </button>
                </div>
                
                <div id="detailsArea" style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    <p style="color: #666;">点击上方按钮查看更多详细信息或生成AI摘要</p>
                </div>
            `;
            
            // 保存数据到全局变量，供其他函数使用
            window.currentChatData = chat_data;
            window.currentContacts = contacts;
            updateBackButton();
        }
        
        // 生成AI摘要
        async function generateSummary() {
            if (!window.currentChatData) {
                alert('请先选择并分析聊天文件');
                return;
            }
            
            document.getElementById('detailsArea').innerHTML = `
                <p style="color: #007AFF;">正在生成AI摘要，请稍候...</p>
            `;
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/generate-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_data: window.currentChatData
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                document.getElementById('detailsArea').innerHTML = `
                    <h4 style="margin: 0 0 10px 0; color: #007AFF;">🤖 AI生成摘要</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${data.summary}</div>
                    <button onclick="exportSummary('${data.summary}')" style="margin-top: 10px; padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        导出摘要
                    </button>
                `;
                
            } catch (error) {
                console.error('生成摘要失败:', error);
                document.getElementById('detailsArea').innerHTML = `
                    <p style="color: #FF3B30;">生成摘要失败: ${error.message}</p>
                    <p style="color: #666;">请检查API密钥配置或网络连接。</p>
                `;
            }
        }
        
        // 显示聊天详细内容
        function showChatDetails() {
            if (!window.currentChatData) {
                alert('请先选择并分析聊天文件');
                return;
            }
            
            const messages = window.currentChatData.slice(0, 50); // 只显示前50条消息
            let html = `
                <h4 style="margin: 0 0 10px 0; color: #34C759;">💬 聊天记录详情 (显示前50条)</h4>
                <div style="background: white; padding: 15px; border-radius: 8px;">
            `;
            
            messages.forEach(msg => {
                const time = new Date(msg.timestamp).toLocaleString();
                html += `
                    <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #007AFF; background: #f9f9f9;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 3px;">
                            ${msg.sender} - ${time}
                        </div>
                        <div>${msg.content}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (window.currentChatData.length > 50) {
                html += `<p style="color: #666; margin-top: 10px;">还有 ${window.currentChatData.length - 50} 条消息未显示</p>`;
            }
            
            document.getElementById('detailsArea').innerHTML = html;
        }
        
        // 筛选聊天记录
        function filterChat() {
            if (!window.currentChatData) {
                alert('请先选择并分析聊天文件');
                return;
            }
            
            const contacts = Array.from(window.currentContacts);
            let contactOptions = contacts.map(contact => `<option value="${contact}">${contact}</option>`).join('');
            
            document.getElementById('detailsArea').innerHTML = `
                <h4 style="margin: 0 0 15px 0; color: #FF9500;">🔍 筛选聊天记录</h4>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">按发送者筛选:</label>
                        <select id="senderFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">全部发送者</option>
                            ${contactOptions}
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">开始时间:</label>
                            <input type="datetime-local" id="startTime" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">结束时间:</label>
                            <input type="datetime-local" id="endTime" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <button onclick="applyFilter()" style="width: 100%; padding: 10px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        应用筛选
                    </button>
                </div>
            `;
        }
        
        // 应用筛选条件
        async function applyFilter() {
            const sender = document.getElementById('senderFilter').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/filter-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_data: window.currentChatData,
                        sender: sender || undefined,
                        start_time: startTime || undefined,
                        end_time: endTime || undefined
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const filteredData = data.filtered_data;
                let html = `
                    <h4 style="margin: 0 0 10px 0; color: #FF9500;">🔍 筛选结果 (${filteredData.length} 条消息)</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                `;
                
                if (filteredData.length === 0) {
                    html += '<p style="color: #666;">没有找到符合条件的消息</p>';
                } else {
                    filteredData.slice(0, 30).forEach(msg => {
                        const time = new Date(msg.timestamp).toLocaleString();
                        html += `
                            <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #FF9500; background: #f9f9f9;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">
                                    ${msg.sender} - ${time}
                                </div>
                                <div>${msg.content}</div>
                            </div>
                        `;
                    });
                    
                    if (filteredData.length > 30) {
                        html += `<p style="color: #666; margin-top: 10px;">还有 ${filteredData.length - 30} 条消息未显示</p>`;
                    }
                }
                
                html += '</div>';
                
                document.getElementById('detailsArea').innerHTML = html;
                
            } catch (error) {
                console.error('筛选失败:', error);
                document.getElementById('detailsArea').innerHTML = `
                    <p style="color: #FF3B30;">筛选失败: ${error.message}</p>
                `;
            }
        }
        
        // 导出摘要
        async function exportSummary(summary) {
            try {
                const response = await fetch('http://127.0.0.1:5000/api/export-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        summary: summary
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                alert(`摘要已导出到: ${data.file_path}`);
                
            } catch (error) {
                console.error('导出失败:', error);
                alert(`导出失败: ${error.message}`);
            }
        }
        async function scanChats() {
            document.getElementById('results').innerHTML = `
                <h3>分析结果</h3>
                <p style="color: #007AFF;">正在扫描聊天记录...</p>
            `;
            // TODO: 调用后端API扫描聊天记录
        }
        
        function openSettings() {
            addToHistory('settings');
            showInitializationWizard();
        }

        // 显示聊天分析结果
        function displayChatAnalysis(data, filePath) {
            addToHistory('analysis');
            
            const { chat_data, contacts } = data;
            const messageCount = chat_data.length;
            const contactList = Array.from(contacts).join(', ');
            
            // 获取时间范围
            let timeRange = '';
            if (messageCount > 0) {
                const firstMessage = new Date(chat_data[0].timestamp);
                const lastMessage = new Date(chat_data[messageCount - 1].timestamp);
                timeRange = `${firstMessage.toLocaleDateString()} - ${lastMessage.toLocaleDateString()}`;
            }
            
            document.getElementById('results').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">分析结果</h3>
                    <button onclick="clearResults()" style="padding: 6px 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        清除结果
                    </button>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #34C759;">✅ 文件解析成功</h4>
                    <p><strong>文件路径:</strong> ${filePath}</p>
                    <p><strong>消息数量:</strong> ${messageCount} 条</p>
                    <p><strong>参与人员:</strong> ${contactList}</p>
                    <p><strong>时间范围:</strong> ${timeRange}</p>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="generateSummary()" style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        生成AI摘要
                    </button>
                    <button onclick="showChatDetails()" style="padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        查看详细内容
                    </button>
                    <button onclick="filterChat()" style="padding: 8px 16px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        筛选消息
                    </button>
                </div>
                
                <div id="detailsArea" style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    <p style="color: #666;">点击上方按钮查看更多详细信息或生成AI摘要</p>
                </div>
            `;
            
            // 保存数据到全局变量，供其他函数使用
            window.currentChatData = chat_data;
            window.currentContacts = contacts;
            updateBackButton();
        }
        
        // 清除分析结果，返回主界面
        function clearResults() {
            document.getElementById('results').innerHTML = `
                <h3>分析结果</h3>
                <p style="color: #666;">请选择上述功能开始使用 MemoChat</p>
            `;
            
            // 清除全局数据
            window.currentChatData = null;
            window.currentContacts = null;
            
            // 移除分析页面的历史记录
            if (pageHistory.length > 0 && pageHistory[pageHistory.length - 1].name === 'analysis') {
                pageHistory.pop();
                updateBackButton();
            }
        }

        // 生成AI摘要
        async function generateSummary() {
            if (!window.currentChatData) {
                alert('请先选择并分析聊天文件');
                return;
            }
            
            document.getElementById('detailsArea').innerHTML = `
                <p style="color: #007AFF;">正在生成AI摘要，请稍候...</p>
            `;
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/generate-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_data: window.currentChatData
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                document.getElementById('detailsArea').innerHTML = `
                    <h4 style="margin: 0 0 10px 0; color: #007AFF;">🤖 AI生成摘要</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${data.summary}</div>
                    <button onclick="exportSummary('${data.summary}')" style="margin-top: 10px; padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        导出摘要
                    </button>
                `;
                
            } catch (error) {
                console.error('生成摘要失败:', error);
                document.getElementById('detailsArea').innerHTML = `
                    <p style="color: #FF3B30;">生成摘要失败: ${error.message}</p>
                    <p style="color: #666;">请检查API密钥配置或网络连接。</p>
                `;
            }
        }
        
        // 显示聊天详细内容
        function showChatDetails() {
            if (!window.currentChatData) {
                alert('请先选择并分析聊天文件');
                return;
            }
            
            const messages = window.currentChatData.slice(0, 50); // 只显示前50条消息
            let html = `
                <h4 style="margin: 0 0 10px 0; color: #34C759;">💬 聊天记录详情 (显示前50条)</h4>
                <div style="background: white; padding: 15px; border-radius: 8px;">
            `;
            
            messages.forEach(msg => {
                const time = new Date(msg.timestamp).toLocaleString();
                html += `
                    <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #007AFF; background: #f9f9f9;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 3px;">
                            ${msg.sender} - ${time}
                        </div>
                        <div>${msg.content}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (window.currentChatData.length > 50) {
                html += `<p style="color: #666; margin-top: 10px;">还有 ${window.currentChatData.length - 50} 条消息未显示</p>`;
            }
            
            document.getElementById('detailsArea').innerHTML = html;
        }
        
        // 筛选聊天记录
        function filterChat() {
            if (!window.currentChatData) {
                alert('请先选择并分析聊天文件');
                return;
            }
            
            const contacts = Array.from(window.currentContacts);
            let contactOptions = contacts.map(contact => `<option value="${contact}">${contact}</option>`).join('');
            
            document.getElementById('detailsArea').innerHTML = `
                <h4 style="margin: 0 0 15px 0; color: #FF9500;">🔍 筛选聊天记录</h4>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">按发送者筛选:</label>
                        <select id="senderFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">全部发送者</option>
                            ${contactOptions}
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">开始时间:</label>
                            <input type="datetime-local" id="startTime" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">结束时间:</label>
                            <input type="datetime-local" id="endTime" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <button onclick="applyFilter()" style="width: 100%; padding: 10px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        应用筛选
                    </button>
                </div>
            `;
        }
        
        // 应用筛选条件
        async function applyFilter() {
            const sender = document.getElementById('senderFilter').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/filter-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_data: window.currentChatData,
                        sender: sender || undefined,
                        start_time: startTime || undefined,
                        end_time: endTime || undefined
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const filteredData = data.filtered_data;
                let html = `
                    <h4 style="margin: 0 0 10px 0; color: #FF9500;">🔍 筛选结果 (${filteredData.length} 条消息)</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                `;
                
                if (filteredData.length === 0) {
                    html += '<p style="color: #666;">没有找到符合条件的消息</p>';
                } else {
                    filteredData.slice(0, 30).forEach(msg => {
                        const time = new Date(msg.timestamp).toLocaleString();
                        html += `
                            <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #FF9500; background: #f9f9f9;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">
                                    ${msg.sender} - ${time}
                                </div>
                                <div>${msg.content}</div>
                            </div>
                        `;
                    });
                    
                    if (filteredData.length > 30) {
                        html += `<p style="color: #666; margin-top: 10px;">还有 ${filteredData.length - 30} 条消息未显示</p>`;
                    }
                }
                
                html += '</div>';
                
                document.getElementById('detailsArea').innerHTML = html;
                
            } catch (error) {
                console.error('筛选失败:', error);
                document.getElementById('detailsArea').innerHTML = `
                    <p style="color: #FF3B30;">筛选失败: ${error.message}</p>
                `;
            }
        }
        
        // 导出摘要
        async function exportSummary(summary) {
            try {
                const response = await fetch('http://127.0.0.1:5000/api/export-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        summary: summary
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                alert(`摘要已导出到: ${data.file_path}`);
                
            } catch (error) {
                console.error('导出失败:', error);
                alert(`导出失败: ${error.message}`);
            }
        }
        async function scanChats() {
            document.getElementById('results').innerHTML = `
                <h3>分析结果</h3>
                <p style="color: #007AFF;">正在扫描聊天记录...</p>
            `;
            // TODO: 调用后端API扫描聊天记录
        }
        
        function openSettings() {
            showInitializationWizard();
        }
    </script>
</body>
</html>
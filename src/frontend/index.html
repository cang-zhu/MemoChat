<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoChat - AI智能聊天摘要</title>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }
        #root {
            height: 100vh;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 18px;
            color: #666;
        }
        
        /* Markdown渲染样式 */
        .rendered-content {
            line-height: 1.6;
            color: #333;
        }
        
        .rendered-content h1, .rendered-content h2, .rendered-content h3, 
        .rendered-content h4, .rendered-content h5, .rendered-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #2c3e50;
        }
        
        .rendered-content h1 { font-size: 1.8em; border-bottom: 2px solid #3498db; padding-bottom: 0.3em; }
        .rendered-content h2 { font-size: 1.5em; border-bottom: 1px solid #bdc3c7; padding-bottom: 0.2em; }
        .rendered-content h3 { font-size: 1.3em; }
        .rendered-content h4 { font-size: 1.1em; }
        
        .rendered-content p {
            margin: 1em 0;
        }
        
        .rendered-content code {
            background-color: #f8f9fa;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
        
        .rendered-content pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1em;
            overflow-x: auto;
            margin: 1em 0;
        }
        
        .rendered-content pre code {
            background: none;
            padding: 0;
        }
        
        .rendered-content blockquote {
            border-left: 4px solid #3498db;
            margin: 1em 0;
            padding-left: 1em;
            color: #666;
            font-style: italic;
        }
        
        .rendered-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        
        .rendered-content th, .rendered-content td {
            border: 1px solid #ddd;
            padding: 0.5em;
            text-align: left;
        }
        
        .rendered-content th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .rendered-content ul, .rendered-content ol {
            margin: 1em 0;
            padding-left: 2em;
        }
        
        .rendered-content li {
            margin: 0.5em 0;
        }
        
        /* MathJax公式样式 */
        .MathJax {
            font-size: 1.1em !important;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">正在加载 MemoChat...</div>
    </div>
    
    <!-- 添加Markdown和MathJax支持 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
        // MathJax配置
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script>
        const { ipcRenderer } = require('electron');
        
        // Markdown和LaTeX渲染器类
        class ContentRenderer {
            constructor() {
                // 延迟初始化marked，确保库已加载
                this.markedReady = false;
                this.initMarked();
            }
            
            initMarked() {
                // 检查marked是否已加载
                if (typeof marked !== 'undefined') {
                    this.marked = marked;
                    // 配置marked选项
                    this.marked.setOptions({
                        breaks: true,
                        gfm: true,
                        tables: true,
                        sanitize: false
                    });
                    this.markedReady = true;
                } else {
                    // 如果还没加载，等待一段时间后重试
                    setTimeout(() => this.initMarked(), 100);
                }
            }
            
            /**
             * 渲染Markdown+LaTeX内容为HTML
             * @param {string} rawContent - 原始Markdown+LaTeX字符串
             * @returns {string} 渲染后的HTML字符串
             */
            renderContent(rawContent) {
                if (!rawContent) return '';
                
                // 如果marked还没准备好，返回原始内容
                if (!this.markedReady) {
                    return this.escapeHtml(rawContent);
                }
                
                // 预处理LaTeX公式
                let processedContent = this.preprocessLatex(rawContent);
                
                // Markdown转HTML
                let html = this.marked.parse(processedContent);
                
                return html;
            }
            
            /**
             * 转义HTML特殊字符
             * @param {string} text - 原始文本
             * @returns {string} 转义后的文本
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            /**
             * 预处理LaTeX公式，转换为MathJax可识别的格式
             * @param {string} content - 原始内容
             * @returns {string} 处理后的内容
             */
            preprocessLatex(content) {
                // 将\[ ... \]替换为$$ ... $$（块级公式）
                content = content.replace(/\\\[([\s\S]*?)\\\]/g, (match, formula) => {
                    return `$$ ${formula} $$`;
                });
                
                // 将[ ... ]替换为$$ ... $$（如果不在链接中）
                content = content.replace(/(?<!\!)\[([^\[\]]*?)\](?!\()/g, (match, formula) => {
                    // 检查是否是数学公式（包含数学符号）
                    if (this.isMathFormula(formula)) {
                        return `$$ ${formula} $$`;
                    }
                    return match; // 保持原样，可能是普通的方括号
                });
                
                // 处理行内公式 \( ... \)
                content = content.replace(/\\\(([\s\S]*?)\\\)/g, (match, formula) => {
                    return `$ ${formula} $`;
                });
                
                return content;
            }
            
            /**
             * 判断是否为数学公式
             * @param {string} text - 待判断的文本
             * @returns {boolean} 是否为数学公式
             */
            isMathFormula(text) {
                // 检查是否包含数学符号
                const mathSymbols = /[\\{}^_=+\-*/()∑∫∏√∞≤≥≠±×÷∂∇∆Ω∈∉⊂⊃∪∩]/;
                const mathFunctions = /\\(text|frac|sqrt|sum|int|prod|lim|sin|cos|tan|log|ln|exp|alpha|beta|gamma|delta|epsilon|theta|lambda|mu|pi|sigma|phi|psi|omega)/;
                
                return mathSymbols.test(text) || mathFunctions.test(text);
            }
            
            /**
             * 渲染内容并更新DOM，同时刷新MathJax
             * @param {string} rawContent - 原始内容
             * @param {HTMLElement} targetElement - 目标DOM元素
             */
            renderToElement(rawContent, targetElement) {
                const html = this.renderContent(rawContent);
                targetElement.innerHTML = html;
                targetElement.classList.add('rendered-content');
                
                // 刷新MathJax渲染
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([targetElement]).catch((err) => {
                        console.warn('MathJax渲染错误:', err);
                    });
                }
            }
        }
        
        // 等待页面加载完成后创建渲染器实例
        let contentRenderer = null;
        
        // 初始化渲染器
        function initRenderer() {
            if (!contentRenderer) {
                contentRenderer = new ContentRenderer();
            }
        }
        
        let initializationChecked = false;
        
        // 页面导航系统
        let pageHistory = [];
        let currentPage = null;
        
        // 添加页面到历史记录
        function addToHistory(pageName, pageData = null) {
            if (currentPage && currentPage !== pageName) {
                pageHistory.push({
                    name: currentPage,
                    data: pageData
                });
            }
            currentPage = pageName;
            updateBackButton();
        }
        
        // 更新返回按钮显示状态
        function updateBackButton() {
            const backButton = document.getElementById('backButton');
            if (backButton) {
                if (pageHistory.length > 0) {
                    backButton.style.display = 'inline-block';
                } else {
                    backButton.style.display = 'none';
                }
            }
        }
        
        // 返回上一页
        function goBack() {
            if (pageHistory.length > 0) {
                const previousPage = pageHistory.pop();
                currentPage = previousPage.name;
                
                // 根据页面类型调用相应的显示函数
                switch (previousPage.name) {
                    case 'main':
                        showMainApp();
                        break;
                    case 'initialization':
                        showInitializationWizard();
                        break;
                    default:
                        showMainApp();
                        break;
                }
                
                updateBackButton();
            }
        }
        
        // 创建返回按钮HTML
        function createBackButton() {
            return `
                <button id="backButton" onclick="goBack()" 
                        style="position: absolute; top: 20px; left: 20px; padding: 8px 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; display: none; z-index: 1000;">
                    ← 返回
                </button>
            `;
        }

        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing renderer and checking status...');
            initRenderer();
            checkInitializationStatus();
        });
        
        // 主动检查初始化状态
        async function checkInitializationStatus() {
            if (initializationChecked) return;
            initializationChecked = true;
            
            try {
                // 获取配置信息
                const config = await ipcRenderer.invoke('get-config');
                console.log('Config loaded:', config);
                
                // 检查是否需要初始化
                const needsInit = !config.api.key || 
                                 (!config.chatRecords.wechat.mac && !config.chatRecords.wechat.windows &&
                                  !config.chatRecords.qq.mac && !config.chatRecords.qq.windows);
                
                console.log('Needs initialization:', needsInit);
                
                if (needsInit) {
                    showInitializationWizard();
                } else {
                    showMainApp();
                }
            } catch (error) {
                console.error('Failed to check initialization status:', error);
                // 如果检查失败，默认显示初始化界面
                showInitializationWizard();
            }
        }
        
        // 监听来自主进程的初始化状态（备用方案）
        ipcRenderer.on('initialization-status', (event, data) => {
            console.log('Received initialization status:', data);
            if (!initializationChecked) {
                initializationChecked = true;
                if (data.needsInitialization) {
                    showInitializationWizard();
                } else {
                    showMainApp();
                }
            }
        });
        
        function showInitializationWizard() {
            console.log('Showing initialization wizard');
            addToHistory('initialization');
            
            const root = document.getElementById('root');
            root.innerHTML = `
                ${createBackButton()}
                <div style="padding: 40px; max-width: 600px; margin: 0 auto;">
                    <h1 style="text-align: center; color: #333;">欢迎使用 MemoChat</h1>
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h2>初始化设置</h2>
                        <p>请完成以下设置以开始使用 MemoChat：</p>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">API 密钥：</label>
                            <input type="text" id="apiKey" placeholder="请输入您的通义千问API密钥" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">AI模型选择：</label>
                            <select id="selectedModel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                                <option value="qwen-turbo-latest">通义千问-Turbo (免费)</option>
                                <option value="qwen-plus-latest">通义千问-Plus (付费)</option>
                                <option value="qwen-max-latest">通义千问-Max (付费)</option>
                            </select>
                            <small style="display: block; color: #666; margin-top: 5px;">
                                推荐使用 Turbo 模型，免费且性能优秀
                            </small>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">聊天记录路径：</label>
                            <button onclick="selectChatPath()" 
                                    style="padding: 10px 20px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                选择聊天记录目录
                            </button>
                            <div id="selectedPath" style="margin-top: 10px; color: #666;"></div>
                        </div>
                        
                        <button onclick="completeSetup()" 
                                style="width: 100%; padding: 12px; background: #34C759; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
                            完成设置
                        </button>
                    </div>
                </div>
            `;
            updateBackButton();
        }
        
        function showMainApp() {
            console.log('Showing main app');
            addToHistory('main');
            
            const root = document.getElementById('root');
            root.innerHTML = `
                ${createBackButton()}
                <div style="padding: 20px; height: 100vh; display: flex; flex-direction: column; position: relative;">
                    <header style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h1 style="margin: 0; color: #333;">MemoChat - AI智能聊天摘要</h1>
                        <p style="margin: 10px 0 0 0; color: #666;">智能分析您的聊天记录，生成专业摘要</p>
                    </header>
                    
                    <div style="flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h2>功能区域</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>📁 文件上传</h3>
                                <p>上传聊天记录文件进行分析</p>
                                <button onclick="uploadFile()" style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    选择文件
                                </button>
                            </div>
                            
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>🔍 路径扫描</h3>
                                <p>自动扫描本地聊天记录</p>
                                <button onclick="scanChats()" style="padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    开始扫描
                                </button>
                            </div>
                            
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>⚙️ 设置</h3>
                                <p>修改应用配置和API密钥</p>
                                <button onclick="openSettings()" style="padding: 8px 16px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    打开设置
                                </button>
                            </div>
                            
                            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3>🔧 测试连接</h3>
                                <p>测试与后端服务的连接状态</p>
                                <button onclick="testBackendConnection()" style="padding: 8px 16px; background: #6C757D; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    测试后端
                                </button>
                            </div>
                        </div>
                        
                        <div id="results" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 200px;">
                            <h3>分析结果</h3>
                            <p style="color: #666;">请选择上述功能开始使用 MemoChat</p>
                        </div>
                    </div>
                </div>
            `;
            updateBackButton();
        }

        // 设置页面
        function openSettings() {
            console.log('Opening settings');
            addToHistory('settings');
            
            const root = document.getElementById('root');
            root.innerHTML = `
                ${createBackButton()}
                <div style="padding: 40px; max-width: 800px; margin: 0 auto;">
                    <h1 style="text-align: center; color: #333;">⚙️ 应用设置</h1>
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        
                        <!-- API设置区域 -->
                        <div style="margin-bottom: 40px;">
                            <h3 style="color: #495057; margin-bottom: 20px; font-size: 18px;">🔑 API设置</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">通义千问API密钥:</label>
                                <input type="password" id="settingsApiKey" placeholder="请输入您的API密钥 (sk-xxxxxxxx...)" 
                                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                                <button onclick="saveAPIKey()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-top: 10px;">
                                    保存API密钥
                                </button>
                                <small style="display: block; color: #666; margin-top: 4px;">
                                    您可以在 <a href="https://dashscope.console.aliyun.com/" target="_blank" rel="noopener noreferrer">阿里云百炼控制台</a> 获取API密钥
                                </small>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">🤖 AI模型选择:</label>
                                
                                <!-- 当前模型显示 -->
                                <div id="currentModelDisplay" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;">
                                    <strong>当前模型:</strong> <span id="currentModelName">加载中...</span>
                                    <span id="currentModelBadge" style="margin-left: 10px; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;"></span>
                                </div>
                                
                                <select id="settingsSelectedModel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                                    <option value="qwen-turbo-latest">通义千问-Turbo (免费)</option>
                                    <option value="qwen-plus-latest">通义千问-Plus (付费)</option>
                                    <option value="qwen-max-latest">通义千问-Max (付费)</option>
                                </select>
                                <button onclick="saveModel()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-top: 10px;">
                                    保存模型配置
                                </button>
                                
                                <div id="modelInfo" style="margin-top: 10px; font-size: 14px;">
                                    <span style="color: #28a745;">✅ 免费模型，无需额外费用</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 聊天记录路径设置区域 -->
                        <div style="margin-bottom: 40px;">
                            <h3 style="color: #495057; margin-bottom: 20px; font-size: 18px;">📁 聊天记录路径设置</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">微信聊天记录路径 (Windows):</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="wechatWindowsPath" readonly placeholder="未设置路径" 
                                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button onclick="selectPath('wechat', 'windows')" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        选择路径
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">微信聊天记录路径 (Mac):</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="wechatMacPath" readonly placeholder="未设置路径" 
                                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button onclick="selectPath('wechat', 'mac')" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        选择路径
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">QQ聊天记录路径 (Windows):</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="qqWindowsPath" readonly placeholder="未设置路径" 
                                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button onclick="selectPath('qq', 'windows')" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        选择路径
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">QQ聊天记录路径 (Mac):</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="qqMacPath" readonly placeholder="未设置路径" 
                                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button onclick="selectPath('qq', 'mac')" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        选择路径
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 消息提示区域 -->
                        <div id="settingsMessage" style="display: none; padding: 10px; margin: 20px 0; border-radius: 4px; border: 1px solid;"></div>
                    </div>
                </div>
            `;
            updateBackButton();
            loadSettingsData();
        }

        // 加载设置数据
        async function loadSettingsData() {
            try {
                const config = await ipcRenderer.invoke('get-config');
                console.log('Settings config loaded:', config);
                
                // 加载API密钥
                if (config.api?.key) {
                    document.getElementById('settingsApiKey').value = config.api.key;
                }
                
                // 加载当前模型
                const currentModel = config.api?.model || 'qwen-turbo-latest';
                document.getElementById('settingsSelectedModel').value = currentModel;
                
                // 显示当前模型信息
                const modelNames = {
                    'qwen-turbo-latest': '通义千问-Turbo (免费)',
                    'qwen-plus-latest': '通义千问-Plus (付费)',
                    'qwen-max-latest': '通义千问-Max (付费)'
                };
                
                const modelFree = {
                    'qwen-turbo-latest': true,
                    'qwen-plus-latest': false,
                    'qwen-max-latest': false
                };
                
                document.getElementById('currentModelName').textContent = modelNames[currentModel];
                const badge = document.getElementById('currentModelBadge');
                badge.textContent = modelFree[currentModel] ? '免费' : '付费';
                badge.style.background = modelFree[currentModel] ? '#28a745' : '#ffc107';
                badge.style.color = modelFree[currentModel] ? 'white' : '#212529';
                
                // 更新模型信息
                updateModelInfo(currentModel);
                
                // 加载聊天路径
                const chatPaths = await ipcRenderer.invoke('get-chat-paths');
                if (chatPaths?.wechat?.windows) {
                    document.getElementById('wechatWindowsPath').value = chatPaths.wechat.windows;
                }
                if (chatPaths?.wechat?.mac) {
                    document.getElementById('wechatMacPath').value = chatPaths.wechat.mac;
                }
                if (chatPaths?.qq?.windows) {
                    document.getElementById('qqWindowsPath').value = chatPaths.qq.windows;
                }
                if (chatPaths?.qq?.mac) {
                    document.getElementById('qqMacPath').value = chatPaths.qq.mac;
                }
                
            } catch (error) {
                console.error('加载设置失败:', error);
                showSettingsMessage('加载设置失败: ' + error.message, 'error');
            }
        }

        // 更新模型信息显示
        function updateModelInfo(model) {
            const modelInfo = document.getElementById('modelInfo');
            if (model === 'qwen-turbo-latest') {
                modelInfo.innerHTML = '<span style="color: #28a745;">✅ 免费模型，无需额外费用</span>';
            } else {
                modelInfo.innerHTML = '<span style="color: #ffc107;">💰 付费模型，需要相应权限和余额</span>';
            }
        }

        // 监听模型选择变化
        document.addEventListener('change', function(e) {
            if (e.target.id === 'settingsSelectedModel') {
                updateModelInfo(e.target.value);
            }
        });

        // 显示设置消息
        function showSettingsMessage(message, type = 'success') {
            const messageDiv = document.getElementById('settingsMessage');
            messageDiv.style.display = 'block';
            messageDiv.textContent = message;
            
            if (type === 'success') {
                messageDiv.style.background = '#d4edda';
                messageDiv.style.color = '#155724';
                messageDiv.style.borderColor = '#c3e6cb';
            } else {
                messageDiv.style.background = '#f8d7da';
                messageDiv.style.color = '#721c24';
                messageDiv.style.borderColor = '#f5c6cb';
            }
            
            // 3秒后自动隐藏
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // 保存API密钥
        async function saveAPIKey() {
            const apiKey = document.getElementById('settingsApiKey').value;
            if (!apiKey) {
                showSettingsMessage('请输入API密钥', 'error');
                return;
            }
            
            try {
                const result = await ipcRenderer.invoke('save-api-key', apiKey);
                if (result.success) {
                    showSettingsMessage('API密钥保存成功');
                } else {
                    showSettingsMessage('保存失败: ' + result.error, 'error');
                }
            } catch (error) {
                showSettingsMessage('保存失败: ' + error.message, 'error');
            }
        }

        // 保存模型配置
        async function saveModel() {
            const selectedModel = document.getElementById('settingsSelectedModel').value;
            
            try {
                const result = await ipcRenderer.invoke('save-model-config', selectedModel);
                if (result.success) {
                    showSettingsMessage('模型配置保存成功');
                    // 更新当前模型显示
                    loadSettingsData();
                } else {
                    showSettingsMessage('保存失败: ' + result.error, 'error');
                }
            } catch (error) {
                showSettingsMessage('保存失败: ' + error.message, 'error');
            }
        }

        // 选择路径
        async function selectPath(platform, os) {
            try {
                const path = await ipcRenderer.invoke('select-directory');
                if (path) {
                    const inputId = `${platform}${os.charAt(0).toUpperCase() + os.slice(1)}Path`;
                    document.getElementById(inputId).value = path;
                    
                    // 保存路径 - 修复参数结构
                    const result = await ipcRenderer.invoke('save-chat-path', { 
                        platform: os, 
                        type: platform, 
                        path: path 
                    });
                    if (result.success) {
                        showSettingsMessage(`${platform.toUpperCase()} ${os} 路径保存成功`);
                    } else {
                        showSettingsMessage('路径保存失败: ' + result.error, 'error');
                    }
                }
            } catch (error) {
                showSettingsMessage('选择路径失败: ' + error.message, 'error');
            }
        }

        // 初始化设置相关函数
        async function selectChatPath() {
            try {
                const path = await ipcRenderer.invoke('select-directory');
                if (path) {
                    document.getElementById('selectedPath').textContent = `已选择: ${path}`;
                    window.selectedChatPath = path;
                }
            } catch (error) {
                alert('选择目录失败: ' + error.message);
            }
        }
        
        async function completeSetup() {
            const apiKey = document.getElementById('apiKey').value;
            const selectedModel = document.getElementById('selectedModel').value;
            const chatPath = window.selectedChatPath;
            
            if (!apiKey) {
                alert('请输入API密钥');
                return;
            }
            
            if (!chatPath) {
                alert('请选择聊天记录路径');
                return;
            }
            
            try {
                const result = await ipcRenderer.invoke('complete-initialization', {
                    apiKey: apiKey,
                    selectedModel: selectedModel,
                    chatPaths: {
                        wechat: chatPath,
                        qq: chatPath
                    }
                });
                
                if (result.success) {
                    alert('设置完成！');
                    showMainApp();
                } else {
                    alert('设置失败: ' + result.error);
                }
            } catch (error) {
                alert('设置失败: ' + error.message);
            }
        }
        
        // 测试后端连接函数
        async function testBackendConnection() {
            console.log('开始测试后端连接...');
            
            try {
                // 测试根路径
                const rootResult = await ipcRenderer.invoke('api-call', {
                    endpoint: '/',
                    method: 'GET',
                    data: {}
                });
                console.log('根路径响应状态:', rootResult.status);
                console.log('根路径响应数据:', rootResult.data);
                
                // 测试API路径
                const testFilePath = '/Users/huaisang/Documents/研究生/MemoChat/MemoChat_app/test_data/产品需求讨论.txt';
                const apiResult = await ipcRenderer.invoke('api-call', {
                    endpoint: '/api/load-chat',
                    method: 'POST',
                    data: { file_path: testFilePath }
                });
                
                console.log('API响应状态:', apiResult.status);
                console.log('API响应数据:', apiResult.data);
                
                if (apiResult.ok) {
                    alert('后端连接测试成功！检查控制台查看详细信息。');
                } else {
                    console.error('API请求失败:', apiResult.status);
                    alert(`API请求失败: ${apiResult.status}`);
                }
                
            } catch (error) {
                console.error('网络请求失败:', error);
                alert(`网络请求失败: ${error.message}`);
            }
        }
        
        // 主应用功能函数
        async function uploadFile() {
            try {
                const filePath = await ipcRenderer.invoke('select-file');
                if (filePath) {
                    document.getElementById('results').innerHTML = `
                        <h3>分析结果</h3>
                        <p>已选择文件: ${filePath}</p>
                        <p style="color: #007AFF;">正在分析中...</p>
                    `;
                    
                    // 使用IPC调用后端API
                    try {
                        const result = await ipcRenderer.invoke('api-call', {
                            endpoint: '/api/load-chat',
                            method: 'POST',
                            data: { file_path: filePath }
                        });
                        
                        if (!result.ok) {
                            throw new Error(`HTTP error! status: ${result.status}`);
                        }
                        
                        if (result.data.error) {
                            throw new Error(result.data.error);
                        }
                        
                        // 显示分析结果
                        displayChatAnalysis(result.data, filePath);
                        
                    } catch (apiError) {
                        console.error('API调用失败:', apiError);
                        document.getElementById('results').innerHTML = `
                            <h3>分析结果</h3>
                            <p>已选择文件: ${filePath}</p>
                            <p style="color: #FF3B30;">分析失败: ${apiError.message}</p>
                            <p style="color: #666;">请检查文件格式是否正确，或稍后重试。</p>
                        `;
                    }
                }
            } catch (error) {
                alert('文件选择失败: ' + error.message);
            }
        }
        
        async function scanChats() {
            document.getElementById('results').innerHTML = `
                <h3>分析结果</h3>
                <p style="color: #007AFF;">正在扫描本地聊天记录...</p>
            `;
            
            try {
                const result = await ipcRenderer.invoke('api-call', {
                    endpoint: '/api/scan-chats',
                    method: 'POST',
                    data: {}
                });
                
                if (!result.ok) {
                    throw new Error(`HTTP error! status: ${result.status}`);
                }
                
                if (result.data.error) {
                    throw new Error(result.data.error);
                }
                
                // 显示扫描结果
                displayScanResults(result.data);
                
            } catch (error) {
                console.error('扫描失败:', error);
                document.getElementById('results').innerHTML = `
                    <h3>分析结果</h3>
                    <p style="color: #FF3B30;">扫描失败: ${error.message}</p>
                    <p style="color: #666;">请检查聊天记录路径设置是否正确。</p>
                `;
            }
        }
        
        function displayChatAnalysis(data, filePath) {
            // 存储当前数据供后续功能使用
            currentChatData = data.chat_data;
            currentFilePath = filePath;
            
            const results = document.getElementById('results');
            results.innerHTML = `
                <h3>分析结果</h3>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #007AFF;">📄 文件信息</h4>
                    <p style="margin: 5px 0;"><strong>文件路径:</strong> ${filePath}</p>
                    <p style="margin: 5px 0;"><strong>消息总数:</strong> ${data.total_messages || currentChatData?.length || 0}</p>
                    <p style="margin: 5px 0;"><strong>参与人数:</strong> ${data.contacts?.length || 0}</p>
                </div>
                
                <!-- 功能按钮区域 -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #007AFF;">
                    <h4 style="margin: 0 0 15px 0; color: #007AFF;">🛠️ 分析功能</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <button onclick="generateAISummary()" style="padding: 10px 15px; background: #34C759; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            📝 AI摘要
                        </button>
                        <button onclick="showFullRecord()" style="padding: 10px 15px; background: #007AFF; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            📋 完整记录
                        </button>
                        <button onclick="showContentFilter()" style="padding: 10px 15px; background: #FF9500; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            🔍 内容筛选
                        </button>
                    </div>
                </div>
                
                <!-- 结果显示区域 -->
                <div id="analysisResults" style="margin-top: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; color: #666;">
                        请选择上方功能按钮查看详细分析结果
                    </div>
                </div>
            `;
        }

        // AI摘要功能 - 最终修复版本
        async function generateAISummary() {
            console.log('generateAISummary called');
            
            if (!currentChatData) {
                alert('没有可用的聊天数据');
                return;
            }
            
            const resultsDiv = document.getElementById('analysisResults');
            resultsDiv.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #34C759;">
                    <h4 style="margin: 0 0 10px 0; color: #34C759;">📝 AI摘要</h4>
                    <p style="color: #007AFF;">正在生成智能摘要...</p>
                </div>
            `;
            
            try {
                console.log('Calling API with data:', currentChatData);
                const result = await ipcRenderer.invoke('api-call', {
                    endpoint: '/api/generate-summary',
                    method: 'POST',
                    data: {
                        chat_data: currentChatData
                    }
                });
                
                console.log('API result:', result);
                
                // 修复：正确访问返回数据的结构
                let summaryText = '';
                if (result && result.data && result.data.summary) {
                    // 标准API响应格式：{ok: true, status: 200, data: {summary: "..."}}
                    summaryText = result.data.summary;
                } else if (result && result.summary) {
                    // 备用格式：{summary: "..."}
                    summaryText = result.summary;
                } else if (result && typeof result === 'string') {
                    // 直接字符串响应
                    summaryText = result;
                } else {
                    // 其他情况，显示调试信息
                    summaryText = '未收到摘要内容\n\n调试信息：\n' + JSON.stringify(result, null, 2);
                }
                
                console.log('Final summary text:', summaryText);
                
                // 创建摘要显示容器
                const summaryContainer = document.createElement('div');
                summaryContainer.style.cssText = `
                    background: white; 
                    padding: 20px; 
                    border-radius: 8px; 
                    border-left: 4px solid #34C759;
                    margin-bottom: 15px;
                `;
                
                // 创建标题
                const title = document.createElement('h4');
                title.style.cssText = 'margin: 0 0 15px 0; color: #34C759;';
                title.textContent = '📝 AI摘要';
                summaryContainer.appendChild(title);
                
                // 创建内容容器
                const contentDiv = document.createElement('div');
                contentDiv.style.cssText = 'margin-bottom: 15px; white-space: pre-wrap; line-height: 1.6;';
                
                // 显示内容
                contentDiv.textContent = summaryText;
                
                // 尝试使用渲染器（如果可用）
                try {
                    if (!contentRenderer) {
                        console.log('Initializing renderer...');
                        initRenderer();
                    }
                    
                    if (contentRenderer && contentRenderer.markedReady && summaryText && !summaryText.includes('未收到摘要内容')) {
                        console.log('Using renderer...');
                        contentRenderer.renderToElement(summaryText, contentDiv);
                    } else {
                        console.log('Renderer not ready or no content, using plain text');
                    }
                } catch (renderError) {
                    console.error('Rendering error:', renderError);
                    // 如果渲染失败，保持原始文本显示
                }
                
                summaryContainer.appendChild(contentDiv);
                
                // 创建导出按钮
                const exportButton = document.createElement('button');
                exportButton.style.cssText = `
                    padding: 8px 16px; 
                    background: #28a745; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer;
                    margin-right: 10px;
                `;
                exportButton.textContent = '💾 导出摘要';
                exportButton.onclick = () => exportSummary(summaryText, 'ai_summary');
                summaryContainer.appendChild(exportButton);
                
                // 创建复制按钮
                const copyButton = document.createElement('button');
                copyButton.style.cssText = `
                    padding: 8px 16px; 
                    background: #007AFF; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer;
                `;
                copyButton.textContent = '📋 复制内容';
                copyButton.onclick = () => copyToClipboard(summaryText);
                summaryContainer.appendChild(copyButton);
                
                // 更新显示
                resultsDiv.innerHTML = '';
                resultsDiv.appendChild(summaryContainer);
                
                console.log('Summary display completed');
                
            } catch (error) {
                console.error('生成摘要失败:', error);
                resultsDiv.innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF3B30;">
                        <h4 style="margin: 0 0 10px 0; color: #FF3B30;">❌ 生成失败</h4>
                        <p>摘要生成失败: ${error.message}</p>
                        <p style="color: #666;">请检查API配置或稍后重试。</p>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #666;">查看详细错误信息</summary>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 5px; font-size: 12px; overflow-x: auto;">${error.stack || error.toString()}</pre>
                        </details>
                    </div>
                `;
            }
        }
        
        // 复制到剪贴板功能
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showMessage('内容已复制到剪贴板', 'success');
            } catch (err) {
                console.error('复制失败:', err);
                showMessage('复制失败，请手动复制', 'error');
            }
        }
        
        // 显示消息提示
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007AFF'};
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 300);
            }, 3000);
        }
        
        // 添加CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // 完整记录功能
        function showFullRecord() {
            if (!currentChatData) {
                alert('没有可用的聊天数据');
                return;
            }
            
            const resultsDiv = document.getElementById('analysisResults');
            
            // 格式化聊天记录
            let recordHtml = '';
            currentChatData.forEach((message, index) => {
                const timestamp = new Date(message.timestamp).toLocaleString('zh-CN');
                recordHtml += `
                    <div style="margin-bottom: 10px; padding: 10px; background: ${index % 2 === 0 ? '#f8f9fa' : '#ffffff'}; border-radius: 4px; border-left: 3px solid #007AFF;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                            <strong>${message.sender || '未知用户'}</strong> - ${timestamp}
                        </div>
                        <div style="line-height: 1.4;">${message.content || message.message || ''}</div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #007AFF;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #007AFF;">📋 完整记录 (共 ${currentChatData.length} 条消息)</h4>
                        <button onclick="exportSummary(getFullRecordText(), 'full_record')" 
                                style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            💾 导出记录
                        </button>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px;">
                        ${recordHtml}
                    </div>
                </div>
            `;
        }

        // 内容筛选功能
        function showContentFilter() {
            if (!currentChatData) {
                alert('没有可用的聊天数据');
                return;
            }
            
            // 获取所有发送者
            const senders = [...new Set(currentChatData.map(msg => msg.sender || '未知用户'))];
            
            const resultsDiv = document.getElementById('analysisResults');
            resultsDiv.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9500;">
                    <h4 style="margin: 0 0 15px 0; color: #FF9500;">🔍 内容筛选</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">发送者筛选:</label>
                            <select id="senderFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">全部发送者</option>
                                ${senders.map(sender => `<option value="${sender}">${sender}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">关键词搜索:</label>
                            <input type="text" id="keywordFilter" placeholder="输入关键词..." 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">开始时间:</label>
                            <input type="datetime-local" id="startTimeFilter" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">结束时间:</label>
                            <input type="datetime-local" id="endTimeFilter" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 15px;">
                        <button onclick="applyFilters()" style="padding: 10px 20px; background: #FF9500; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                            🔍 应用筛选
                        </button>
                        <button onclick="clearFilters()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            🔄 清除筛选
                        </button>
                    </div>
                    
                    <div id="filterResults" style="border-top: 1px solid #e9ecef; padding-top: 15px;">
                        <p style="color: #666; text-align: center;">请设置筛选条件并点击"应用筛选"</p>
                    </div>
                </div>
            `;
        }

        // 应用筛选
        function applyFilters() {
            const sender = document.getElementById('senderFilter').value;
            const keyword = document.getElementById('keywordFilter').value;
            const startTime = document.getElementById('startTimeFilter').value;
            const endTime = document.getElementById('endTimeFilter').value;
            
            let filteredData = [...currentChatData];
            
            // 按发送者筛选
            if (sender) {
                filteredData = filteredData.filter(msg => msg.sender === sender);
            }
            
            // 按关键词筛选
            if (keyword) {
                filteredData = filteredData.filter(msg => 
                    (msg.content || msg.message || '').toLowerCase().includes(keyword.toLowerCase())
                );
            }
            
            // 按时间筛选
            if (startTime) {
                const startDate = new Date(startTime);
                filteredData = filteredData.filter(msg => new Date(msg.timestamp) >= startDate);
            }
            
            if (endTime) {
                const endDate = new Date(endTime);
                filteredData = filteredData.filter(msg => new Date(msg.timestamp) <= endDate);
            }
            
            // 显示筛选结果
            displayFilterResults(filteredData);
        }

        // 显示筛选结果
        function displayFilterResults(filteredData) {
            const filterResults = document.getElementById('filterResults');
            
            if (filteredData.length === 0) {
                filterResults.innerHTML = `
                    <p style="color: #FF3B30; text-align: center;">没有找到符合条件的消息</p>
                `;
                return;
            }
            
            let resultHtml = `
                <div style="margin-bottom: 10px; font-weight: bold; color: #FF9500;">
                    筛选结果: 共找到 ${filteredData.length} 条消息
                    <button onclick="exportFilteredData()" style="float: right; padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        💾 导出筛选结果
                    </button>
                </div>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px;">
            `;
            
            filteredData.forEach((message, index) => {
                const timestamp = new Date(message.timestamp).toLocaleString('zh-CN');
                resultHtml += `
                    <div style="margin-bottom: 8px; padding: 8px; background: ${index % 2 === 0 ? '#f8f9fa' : '#ffffff'}; border-radius: 4px; border-left: 2px solid #FF9500;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 3px;">
                            <strong>${message.sender || '未知用户'}</strong> - ${timestamp}
                        </div>
                        <div style="font-size: 13px; line-height: 1.3;">${message.content || message.message || ''}</div>
                    </div>
                `;
            });
            
            resultHtml += '</div>';
            filterResults.innerHTML = resultHtml;
            
            // 存储筛选结果供导出使用
            window.currentFilteredData = filteredData;
        }

        // 清除筛选
        function clearFilters() {
            document.getElementById('senderFilter').value = '';
            document.getElementById('keywordFilter').value = '';
            document.getElementById('startTimeFilter').value = '';
            document.getElementById('endTimeFilter').value = '';
            document.getElementById('filterResults').innerHTML = `
                <p style="color: #666; text-align: center;">请设置筛选条件并点击"应用筛选"</p>
            `;
            window.currentFilteredData = null;
        }

        // 获取完整记录文本
        function getFullRecordText() {
            if (!currentChatData) return '';
            
            let text = `聊天记录完整导出\n文件: ${currentFilePath}\n导出时间: ${new Date().toLocaleString('zh-CN')}\n\n`;
            text += '='.repeat(50) + '\n\n';
            
            currentChatData.forEach(message => {
                const timestamp = new Date(message.timestamp).toLocaleString('zh-CN');
                text += `[${timestamp}] ${message.sender || '未知用户'}: ${message.content || message.message || ''}\n\n`;
            });
            
            return text;
        }

        // 导出筛选数据
        function exportFilteredData() {
            if (!window.currentFilteredData) {
                alert('没有筛选数据可导出');
                return;
            }
            
            let text = `聊天记录筛选结果导出\n文件: ${currentFilePath}\n导出时间: ${new Date().toLocaleString('zh-CN')}\n`;
            text += `筛选结果: ${window.currentFilteredData.length} 条消息\n\n`;
            text += '='.repeat(50) + '\n\n';
            
            window.currentFilteredData.forEach(message => {
                const timestamp = new Date(message.timestamp).toLocaleString('zh-CN');
                text += `[${timestamp}] ${message.sender || '未知用户'}: ${message.content || message.message || ''}\n\n`;
            });
            
            exportSummary(text, 'filtered_data');
        }

        // 导出功能
        async function exportSummary(content, type) {
            try {
                const result = await ipcRenderer.invoke('api-call', {
                    endpoint: '/api/export-summary',
                    method: 'POST',
                    data: {
                        summary: content,
                        export_path: null // 使用默认路径
                    }
                });
                
                if (!result.ok) {
                    throw new Error(`HTTP error! status: ${result.status}`);
                }
                
                const data = result.data;
                
                if (data.success) {
                    alert(`导出成功！\n文件保存至: ${data.file_path}`);
                } else {
                    alert('导出失败');
                }
                
            } catch (error) {
                console.error('导出失败:', error);
                alert('导出失败: ' + error.message);
            }
        }
        
        function displayScanResults(data) {
            const results = document.getElementById('results');
            results.innerHTML = `
                <h3>扫描结果</h3>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #34C759;">
                    <h4 style="margin: 0 0 10px 0; color: #34C759;">📊 扫描统计</h4>
                    <p style="margin: 5px 0;"><strong>发现文件:</strong> ${data.files_found || 0} 个</p>
                    <p style="margin: 5px 0;"><strong>总消息数:</strong> ${data.total_messages || 0}</p>
                    <p style="margin: 5px 0;"><strong>扫描路径:</strong> ${data.scan_paths?.join(', ') || '无'}</p>
                </div>
                
                ${data.summary ? `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #007AFF;">
                    <h4 style="margin: 0 0 10px 0; color: #007AFF;">📝 整体摘要</h4>
                    <p style="line-height: 1.6; margin: 0;">${data.summary}</p>
                </div>
                ` : ''}
                
                ${data.files && data.files.length > 0 ? `
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9500;">
                    <h4 style="margin: 0 0 10px 0; color: #FF9500;">📁 发现的文件</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${data.files.map(file => `<li style="margin: 5px 0;">${file}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
            `;
        }
    </script>
</body>
</html>